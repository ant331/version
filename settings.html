<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV Inventory Hub | Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Third-party libraries for file parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }
         .sidebar-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
        }
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .header-right {
             display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--secondary); }
        .btn-outline:hover { background: var(--light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0da271; }
        .btn.btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .data-table th { background-color: var(--light); font-weight: 600; color: var(--secondary); font-size: 0.9rem; }
        .data-table tbody tr:hover { background-color: #f8fafc; }
        .data-table tbody tr.selected { background-color: #fee2e2; }
        .data-table th:first-child, .data-table td:first-child { width: 1%; padding-right: 0.5rem; }
        .table-actions { display: flex; gap: 0.5rem; }

        /* Status & District Badges */
        .badge { display: inline-block; padding: 0.35em 0.65em; font-size: 0.75em; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; }
        .badge-success { color: #065f46; background-color: #d1fae5; }
        .badge-warning { color: #92400e; background-color: #fef3c7; }
        .district-badge { background-color: #e0e7ff; color: #3730a3; text-transform: capitalize; }
        
        /* UPDATED: Added specific country badge styles */
        .country-badge { margin-left: 8px; font-weight: 500; }
        .country-badge-uganda { background-color: #fef3c7; color: #92400e; } /* Yellow */
        .country-badge-drc { background-color: #dbeafe; color: #1e40af; } /* Blue */
        .country-badge-rwanda { background-color: #d1fae5; color: #065f46; } /* Green */


        /* Alert Messages */
        .alert { padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }
        .form-group { margin-bottom: 1.25rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control.error { border-color: var(--danger); }
        .form-text { font-size: 0.8rem; color: var(--secondary); margin-top: 0.25rem; }
        .password-toggle { position: relative; }
        .password-toggle .form-control { padding-right: 2.5rem; }
        .toggle-password { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--secondary); cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background-color: white; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: var(--shadow); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; min-height: 0; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* Table Controls (Search/Filter) */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .search-container { position: relative; flex-grow: 1; max-width: 400px; }
        .search-input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--secondary); }
        .table-actions-buttons { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        
        /* Settings Tabs */
        .settings-tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; flex-wrap: wrap;}
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--secondary); transition: var(--transition); }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .settings-content { display: none; }
        .settings-content.active { display: block; }

        /* Danger Zone */
        .danger-zone { border: 2px solid var(--danger); border-radius: var(--border-radius); margin-top: 2rem; }
        .danger-zone .card-header { background-color: #fee2e2; }
        .danger-zone .card-header h3 { color: #b91c1c; }
        .danger-zone p { margin-bottom: 1rem; color: #b91c1c; }
        
        /* Bulk Upload Preview */
        #upload-preview {
            max-height: 200px; overflow-y: auto; border: 1px solid var(--border);
            padding: 10px; margin-top: 15px; margin-bottom: 15px; border-radius: 8px;
        }
        #upload-preview table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        #upload-preview th, #upload-preview td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>
    <script>
        // Security Check: This script runs first to protect the page.
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedInUser || loggedInUser.role !== 'admin') {
            window.location.href = 'login.html';
        }
    </script>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                 <img src="logo.png" alt="RTV Inventory Hub Logo" class="sidebar-logo">
                 <h2>RTV Inventory Hub</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="Inventory.html" class="menu-item"><i class="fas fa-list"></i><span>Inventory</span></a>
                <a href="supervisor.html" class="menu-item"><i class="fas fa-user-shield"></i><span>Supervisor</span></a>
                 <a href="field_office.html" class="menu-item"><i class="fas fa-warehouse"></i><span>Field Office</span></a>
                 <a href="venn_officer.html" class="menu-item"><i class="fas fa-user-tie"></i><span>Venn Officer</span></a>
                <a href="transfers.html" class="menu-item"><i class="fas fa-exchange-alt"></i><span>Transfers</span></a>
                <a href="reports.html" class="menu-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
                <a href="settings.html" class="menu-item active"><i class="fas fa-cog"></i><span>Settings</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Settings</h1>
                    <p>Manage system settings and user accounts</p>
                </div>
                 <div class="header-right">
                    <div class="user-profile">
                        <div class="avatar" id="user-avatar">A</div>
                        <div>
                            <div id="user-name">Admin</div>
                            <small id="user-role">Administrator</small>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="users">User Management</div>
                <div class="settings-tab" data-tab="myProfile">My Profile</div>
                <div class="settings-tab" data-tab="admins">Admin Accounts</div>
                <div class="settings-tab" data-tab="system">System Configuration</div>
            </div>
            
            <div class="settings-content active" id="usersTab">
                <div class="card">
                    <div class="card-header"><h3>Supervisor Accounts</h3></div>
                    <div class="card-body">
                        <div class="table-controls">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search supervisors..." id="supervisorSearchInput">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div class="table-actions-buttons">
                                <button class="btn btn-danger" id="bulkDeleteSupervisorsBtn" style="display: none;">
                                    <i class="fas fa-trash-alt"></i> Delete Selected
                                </button>
                                <!-- UPDATED: Added Bulk Upload Button -->
                                <button class="btn btn-outline" id="bulkUploadSupervisorBtn"><i class="fas fa-upload"></i> Bulk Upload</button>
                                <button class="btn btn-primary" id="addSupervisorBtn"><i class="fas fa-plus"></i> Add Supervisor</button>
                            </div>
                        </div>
                        <div id="supervisorAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllSupervisors"></th>
                                        <th>Supervisor Info</th>
                                        <th>Contact</th>
                                        <th>District</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="supervisorsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Field Officer Accounts</h3></div>
                    <div class="card-body">
                         <div class="table-controls">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search Field officers..." id="fieldOfficerSearchInput">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div class="table-actions-buttons">
                                <button class="btn btn-danger" id="bulkDeleteFieldOfficersBtn" style="display: none;">
                                    <i class="fas fa-trash-alt"></i> Delete Selected
                                </button>
                                <!-- UPDATED: Added Bulk Upload Button -->
                                <button class="btn btn-outline" id="bulkUploadFieldOfficerBtn"><i class="fas fa-upload"></i> Bulk Upload</button>
                                <button class="btn btn-primary" id="addFieldOfficerBtn"><i class="fas fa-plus"></i> Add Field Officer</button>
                            </div>
                        </div>
                        <div id="fieldOfficerAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllFieldOfficers"></th>
                                        <th>Field Officer Info</th>
                                        <th>Contact</th>
                                        <th>District</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="fieldOfficersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h3>Venn Officer Accounts</h3></div>
                    <div class="card-body">
                         <div class="table-controls">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search Venn officers..." id="vennOfficerSearchInput">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div class="table-actions-buttons">
                                <button class="btn btn-danger" id="bulkDeleteVennOfficersBtn" style="display: none;">
                                    <i class="fas fa-trash-alt"></i> Delete Selected
                                </button>
                                <!-- UPDATED: Added Bulk Upload Button -->
                                <button class="btn btn-outline" id="bulkUploadVennOfficerBtn"><i class="fas fa-upload"></i> Bulk Upload</button>
                                <button class="btn btn-primary" id="addVennOfficerBtn"><i class="fas fa-plus"></i> Add Venn Officer</button>
                            </div>
                        </div>
                        <div id="vennOfficerAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllVennOfficers"></th>
                                        <th>Venn Officer Info</th>
                                        <th>Contact</th>
                                        <th>District</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vennOfficersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Data Collector Accounts</h3></div>
                    <div class="card-body">
                         <div class="table-controls">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search data collectors..." id="dataCollectorSearchInput">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div class="table-actions-buttons">
                                <button class="btn btn-danger" id="bulkDeleteDataCollectorsBtn" style="display: none;">
                                    <i class="fas fa-trash-alt"></i> Delete Selected
                                </button>
                                <button class="btn btn-primary" id="addDataCollectorBtn"><i class="fas fa-plus"></i> Add Collector</button>
                                <button class="btn btn-outline" id="bulkUploadCollectorBtn"><i class="fas fa-upload"></i> Bulk Upload</button>
                            </div>
                        </div>
                        <div id="dataCollectorAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllDataCollectors"></th>
                                        <th>Collector Info</th>
                                        <th>Contact Info</th>
                                        <th>District</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="dataCollectorsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-content" id="myProfileTab">
                <div class="card">
                    <div class="card-header"><h3>Change My Password</h3></div>
                    <div class="card-body">
                        <div id="adminAlert" class="alert"></div>
                        <p class="form-text">Note: You can only change the password for your own account. The primary 'admin' account cannot be deleted.</p>
                        <form id="adminPasswordForm">
                            <div class="form-group password-toggle">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            </div>
                            <div class="form-group password-toggle">
                                <label for="newPassword">New Password</label>
                                <input type="password" class="form-control" id="newPassword" required minlength="6">
                                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                                <div class="form-text">Password must be at least 6 characters.</div>
                            </div>
                            <div class="form-group password-toggle">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmNewPassword" required>
                                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            </div>
                            <button type="submit" class="btn btn-primary" id="adminPasswordSubmitBtn"> Update Password </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="settings-content" id="adminsTab">
                <div class="card">
                    <div class="card-header"><h3>Manage Admin Accounts</h3></div>
                    <div class="card-body">
                        <div class="table-controls">
                            <p class="form-text" style="margin: 0; max-width: 600px;">Add or remove other admin accounts. The primary 'admin' account cannot be deleted.</p>
                            <button class="btn btn-primary" id="addAdminBtn"><i class="fas fa-plus"></i> Add Admin</button>
                        </div>
                        <div id="adminAccountsAlert" class="alert"></div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-content" id="systemTab">
                <div class="card">
                    <div class="card-header"><h3>Manage Districts</h3></div>
                    <div class="card-body">
                        <div id="districtAlert" class="alert"></div>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>District Name</th>
                                        <th>Country</th>
                                        <th>Users Assigned</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="districtsTableBody"></tbody>
                            </table>
                        </div>
                        <form id="addDistrictForm" style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="newDistrictName" class="form-control" placeholder="Enter new district name" required style="flex-grow: 1;">
                            <select id="newDistrictCountry" class="form-control" required style="flex-grow: 0.5;">
                                <option value="Uganda">Uganda</option>
                                <option value="DRC">DRC</option>
                                <option value="Rwanda">Rwanda</option>
                            </select>
                            <button type="submit" class="btn btn-primary" style="flex-grow: 0.5;">Add District</button>
                        </form>
                    </div>
                </div>
                <div class="card danger-zone">
                    <div class="card-header"><h3>Danger Zone</h3></div>
                    <div class="card-body">
                        <p>This action will permanently delete all inventory, users, and logs. This cannot be undone.</p>
                        <button class="btn btn-danger" id="resetDataBtn">Reset Application Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Supervisor Modal -->
    <div class="modal" id="supervisorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="supervisorModalTitle">Add Supervisor</h3>
                <button class="modal-close" data-modal="supervisorModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="supervisorForm">
                    <input type="hidden" id="supervisorId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="supervisorName">Full Name *</label>
                            <input type="text" class="form-control" id="supervisorName" required>
                        </div>
                        <div class="form-group">
                            <label for="supervisorEmpId">FS ID *</label>
                            <input type="text" class="form-control" id="supervisorEmpId" required>
                        </div>
                        <div class="form-group">
                            <label for="supervisorEmail">Email *</label>
                            <input type="email" class="form-control" id="supervisorEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="supervisorPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="supervisorPhone">
                        </div>
                        <div class="form-group full-width">
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">
                            <h4>Login Credentials</h4>
                        </div>
                        <div class="form-group">
                            <label for="supervisorUsername">Username *</label>
                            <input type="text" class="form-control" id="supervisorUsername" required>
                        </div>
                        <div class="form-group password-toggle">
                            <label for="supervisorPassword">Password *</label>
                            <input type="password" class="form-control" id="supervisorPassword">
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            <div class="form-text">Required for new users. Leave blank to keep current password.</div>
                        </div>
                        <div class="form-group">
                            <label for="supervisorDistrict">District *</label>
                            <select class="form-control" id="supervisorDistrict" required></select>
                        </div>
                        <div class="form-group">
                            <label for="supervisorStatus">Status *</label>
                            <select class="form-control" id="supervisorStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="supervisorModal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="supervisorForm" id="saveSupervisorBtn">Save Supervisor</button>
            </div>
        </div>
    </div>
    
    <!-- Field Officer Modal -->
    <div class="modal" id="fieldOfficerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="fieldOfficerModalTitle">Add Field Officer</h3>
                <button class="modal-close" data-modal="fieldOfficerModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fieldOfficerForm">
                    <input type="hidden" id="fieldOfficerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fieldOfficerName">Full Name *</label>
                            <input type="text" class="form-control" id="fieldOfficerName" required>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerEmpId">FS ID *</label>
                            <input type="text" class="form-control" id="fieldOfficerEmpId" required>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerEmail">Email *</label>
                            <input type="email" class="form-control" id="fieldOfficerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="fieldOfficerPhone">
                        </div>
                        <div class="form-group full-width">
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">
                            <h4>Login Credentials</h4>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerUsername">Username *</label>
                            <input type="text" class="form-control" id="fieldOfficerUsername" required>
                        </div>
                        <div class="form-group password-toggle">
                            <label for="fieldOfficerPassword">Password *</label>
                            <input type="password" class="form-control" id="fieldOfficerPassword">
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            <div class="form-text">Required for new users. Leave blank to keep current password.</div>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerDistrict">District *</label>
                            <select class="form-control" id="fieldOfficerDistrict" required></select>
                        </div>
                        <div class="form-group">
                            <label for="fieldOfficerStatus">Status *</label>
                            <select class="form-control" id="fieldOfficerStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="fieldOfficerModal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="fieldOfficerForm" id="saveFieldOfficerBtn">Save Field Officer</button>
            </div>
        </div>
    </div>
    
    <!-- Venn Officer Modal -->
    <div class="modal" id="vennOfficerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="vennOfficerModalTitle">Add Venn Officer</h3>
                <button class="modal-close" data-modal="vennOfficerModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="vennOfficerForm">
                    <input type="hidden" id="vennOfficerId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="vennOfficerName">Full Name *</label>
                            <input type="text" class="form-control" id="vennOfficerName" required>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerEmpId">FS ID *</label>
                            <input type="text" class="form-control" id="vennOfficerEmpId" required>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerEmail">Email *</label>
                            <input type="email" class="form-control" id="vennOfficerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="vennOfficerPhone">
                        </div>
                        <div class="form-group full-width">
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">
                            <h4>Login Credentials</h4>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerUsername">Username *</label>
                            <input type="text" class="form-control" id="vennOfficerUsername" required>
                        </div>
                        <div class="form-group password-toggle">
                            <label for="vennOfficerPassword">Password *</label>
                            <input type="password" class="form-control" id="vennOfficerPassword">
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            <div class="form-text">Required for new users. Leave blank to keep current password.</div>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerDistrict">District *</label>
                            <select class="form-control" id="vennOfficerDistrict" required></select>
                        </div>
                        <div class="form-group">
                            <label for="vennOfficerStatus">Status *</label>
                            <select class="form-control" id="vennOfficerStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="vennOfficerModal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="vennOfficerForm" id="saveVennOfficerBtn">Save Venn Officer</button>
            </div>
        </div>
    </div>

    <!-- Data Collector Modal -->
    <div class="modal" id="dataCollectorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dataCollectorModalTitle">Add Data Collector</h3>
                <button class="modal-close" data-modal="dataCollectorModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dataCollectorForm">
                    <input type="hidden" id="dataCollectorId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="dataCollectorName">Full Name *</label>
                            <input type="text" class="form-control" id="dataCollectorName" required>
                        </div>
                        <div class="form-group">
                            <label for="dataCollectorEmpId">EM_NO *</label>
                            <input type="text" class="form-control" id="dataCollectorEmpId" required>
                        </div>
                        <div class="form-group">
                            <label for="dataCollectorEmail">Email *</label>
                            <input type="email" class="form-control" id="dataCollectorEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="dataCollectorPhone">Phone Number</label>
                            <input type="tel" class="form-control" id="dataCollectorPhone">
                        </div>
                        <div class="form-group full-width">
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">
                            <h4>Login Credentials</h4>
                        </div>
                        <div class="form-group">
                            <label for="dataCollectorUsername">Username *</label>
                            <input type="text" class="form-control" id="dataCollectorUsername" required>
                        </div>
                        <div class="form-group password-toggle">
                            <label for="dataCollectorPassword">Password *</label>
                            <input type="password" class="form-control" id="dataCollectorPassword">
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            <div class="form-text">Required for new users. Leave blank to keep current password.</div>
                        </div>
                        <div class="form-group">
                            <label for="dataCollectorDistrict">District *</label>
                            <select class="form-control" id="dataCollectorDistrict" required></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="dataCollectorModal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="dataCollectorForm" id="saveDataCollectorBtn">Save Collector</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="adminModalTitle">Add Admin</h3>
                <button class="modal-close" data-modal="adminModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adminForm">
                    <input type="hidden" id="adminId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="adminName">Full Name *</label>
                            <input type="text" class="form-control" id="adminName" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmpId">Employee ID</label>
                            <input type="text" class="form-control" id="adminEmpId">
                        </div>
                        <div class="form-group full-width">
                            <hr style="border: none; border-top: 1px solid var(--border); margin: 1rem 0;">
                            <h4>Login Credentials</h4>
                        </div>
                         <div class="form-group">
                            <label for="adminUsername">Username *</label>
                            <input type="text" class="form-control" id="adminUsername" required>
                        </div>
                        <div class="form-group password-toggle">
                            <label for="adminPassword">Password *</label>
                            <input type="password" class="form-control" id="adminPassword">
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            <div class="form-text">Required for new admins. Leave blank to keep current password.</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="adminModal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="adminForm" id="saveAdminBtn">Save Admin</button>
            </div>
        </div>
    </div>
    
    <!-- UPDATED: Generic Bulk Upload Modal -->
    <div class="modal" id="bulkUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bulkUploadModalTitle">Bulk Upload</h3>
                <button class="modal-close" data-modal="bulkUploadModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Download the template, fill in the data, and upload the CSV or Excel file.</p>
                <!-- UPDATED: Changed from <a> to <button> -->
                <button class="btn btn-outline btn-sm" id="downloadTemplateBtn"><i class="fas fa-download"></i> Download Template</button>
                
                <form id="bulkUploadForm" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="collectorFileUpload">Upload CSV/Excel File</label>
                        <input type="file" class="form-control" id="collectorFileUpload" accept=".csv, .xlsx" required>
                    </div>
                    
                    <div id="upload-preview" style="display: none;">
                        <h4>Preview (First 5 Rows)</h4>
                        <table id="preview-table"></table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close" data-modal="bulkUploadModal">Cancel</button>
                <button class="btn btn-success" id="processBulkUploadBtn" disabled>Process Upload</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTS ---
            const SUPERVISOR_KEY = 'supervisors';
            const FIELD_OFFICER_KEY = 'fieldOfficers';
            const VENN_OFFICER_KEY = 'vennOfficers'; // NEW
            const DATA_COLLECTOR_KEY = 'dataCollectors';
            const ADMIN_KEY = 'adminAccounts';
            const DISTRICT_KEY = 'districts';
            const LOGGED_IN_USER_KEY = 'loggedInUser';
            
            // --- INITIAL DATA SETUP (Simulating a database) ---
            function initializeData() {
                if (!localStorage.getItem(SUPERVISOR_KEY)) {
                    // Sample data structure
                    localStorage.setItem(SUPERVISOR_KEY, JSON.stringify([
                        { id: 'sup-1', name: 'Supervisor A', empId: 'FS001', email: 'sup.a@rtv.com', phone: '256701000001', username: 'sup_a', password: 'password', role: 'supervisor', district: 'Kampala', status: 'active' },
                        { id: 'sup-2', name: 'Supervisor B', empId: 'FS002', email: 'sup.b@rtv.com', phone: '256701000002', username: 'sup_b', password: 'password', role: 'supervisor', district: 'Gulu', status: 'inactive' },
                    ]));
                }
                if (!localStorage.getItem(FIELD_OFFICER_KEY)) {
                    localStorage.setItem(FIELD_OFFICER_KEY, JSON.stringify([
                        { id: 'fo-1', name: 'Field Officer A', empId: 'FO001', email: 'fo.a@rtv.com', phone: '256702000001', username: 'fo_a', password: 'password', role: 'field_officer', district: 'Kampala', status: 'active' },
                    ]));
                }
                if (!localStorage.getItem(VENN_OFFICER_KEY)) { // NEW
                    localStorage.setItem(VENN_OFFICER_KEY, JSON.stringify([
                        { id: 'vo-1', name: 'Venn Officer A', empId: 'VO001', email: 'vo.a@rtv.com', phone: '256703000001', username: 'vo_a', password: 'password', role: 'venn_officer', district: 'Gulu', status: 'active' },
                    ]));
                }
                if (!localStorage.getItem(DATA_COLLECTOR_KEY)) {
                    localStorage.setItem(DATA_COLLECTOR_KEY, JSON.stringify([
                        { id: 'dc-1', name: 'Collector A', empId: 'DC001', email: 'dc.a@rtv.com', phone: '256704000001', username: 'dc_a', password: 'password', role: 'data_collector', district: 'Kampala' },
                    ]));
                }
                if (!localStorage.getItem(ADMIN_KEY)) {
                    localStorage.setItem(ADMIN_KEY, JSON.stringify([
                        { id: 'adm-1', name: 'Primary Admin', username: 'admin', password: 'password', role: 'admin', empId: 'ADM001' }
                    ]));
                }
                
                // --- UPDATED: Seeder for districts to be the source of truth ---
                if (!localStorage.getItem(DISTRICT_KEY)) {
                    localStorage.setItem(DISTRICT_KEY, JSON.stringify([
                        { id: 'D001', name: 'Kampala', country: 'Uganda' },
                        { id: 'D002', name: 'Gulu', country: 'Uganda' },
                        { id: 'D003', name: 'Kigali', country: 'Rwanda' },
                        { id: 'D004', name: 'Kinshasa', country: 'DRC' },
                        { id: 'D005', name: 'Mbarara', country: 'Uganda' },
                        { id: 'D006', name: 'Kagadi', country: 'Uganda' },
                        { id: 'D007', name: 'Kyenjojo', country: 'Uganda' },
                        { id: 'D008', name: 'Kyegegwa', country: 'Uganda' }
                    ]));
                }
            }

            // --- DATA GETTERS/SETTERS ---
            const getSupervisorData = () => JSON.parse(localStorage.getItem(SUPERVISOR_KEY) || '[]');
            const saveSupervisorData = (data) => localStorage.setItem(SUPERVISOR_KEY, JSON.stringify(data));
            
            const getFieldOfficerData = () => JSON.parse(localStorage.getItem(FIELD_OFFICER_KEY) || '[]');
            const saveFieldOfficerData = (data) => localStorage.setItem(FIELD_OFFICER_KEY, JSON.stringify(data));

            const getVennOfficerData = () => JSON.parse(localStorage.getItem(VENN_OFFICER_KEY) || '[]'); // NEW
            const saveVennOfficerData = (data) => localStorage.setItem(VENN_OFFICER_KEY, JSON.stringify(data)); // NEW
            
            const getDataCollectorData = () => JSON.parse(localStorage.getItem(DATA_COLLECTOR_KEY) || '[]');
            const saveDataCollectorData = (data) => localStorage.setItem(DATA_COLLECTOR_KEY, JSON.stringify(data));

            const getAdminData = () => JSON.parse(localStorage.getItem(ADMIN_KEY) || '[]');
            const saveAdminData = (data) => localStorage.setItem(ADMIN_KEY, JSON.stringify(data));

            const getDistrictData = () => JSON.parse(localStorage.getItem(DISTRICT_KEY) || '[]');
            const saveDistrictData = (data) => localStorage.setItem(DISTRICT_KEY, JSON.stringify(data));

            const getLoggedInUser = () => JSON.parse(sessionStorage.getItem(LOGGED_IN_USER_KEY));
            
            // --- Global var for bulk upload data ---
            let uploadedUserData = [];

            // --- UTILITY FUNCTIONS ---
            
            // UPDATED: getDistrictName now uses the object array
            function getDistrictName(districtName) {
                const district = getDistrictData().find(d => d.name === districtName);
                if (!district) return `<span class="district-badge">${districtName}</span> <span class="country-badge">N/A</span>`;
                
                const countryClass = `country-badge-${district.country.toLowerCase().replace(' ', '-')}`;
                return `<span class="district-badge">${district.name}</span> <span class="country-badge ${countryClass}">${district.country}</span>`;
            }
            
            function showAlert(alertId, type, message) {
                const alertBox = document.getElementById(alertId);
                alertBox.className = `alert alert-${type}`;
                alertBox.innerHTML = message;
                alertBox.style.display = 'block';
                setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
            }

            function clearForm(formId) {
                document.getElementById(formId).reset();
                document.getElementById(formId.replace('Form', 'Id')).value = ''; // Clear hidden ID
            }
            
            function togglePasswordVisibility(e) {
                const button = e.currentTarget;
                const input = button.closest('.password-toggle').querySelector('input');
                const icon = button.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
            
            // --- CSV/File Download Utility ---
            function downloadCSV(data, filename) {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            // --- UI SETUP ---
            function setupUserUI() {
                const user = getLoggedInUser();
                if (user) {
                    document.getElementById('user-avatar').textContent = user.name ? user.name.charAt(0) : user.username.charAt(0).toUpperCase();
                    document.getElementById('user-name').textContent = user.name || user.username;
                    document.getElementById('user-role').textContent = user.role.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }
            }
            
            function populateDistrictDropdowns() {
                // UPDATED: Now reads from object array
                const districts = getDistrictData().map(d => d.name).sort();
                const dropdowns = [
                    document.getElementById('supervisorDistrict'),
                    document.getElementById('fieldOfficerDistrict'),
                    document.getElementById('vennOfficerDistrict'),
                    document.getElementById('dataCollectorDistrict')
                ];
                
                dropdowns.forEach(dropdown => {
                    if (dropdown) {
                        dropdown.innerHTML = ''; // Clear previous options
                        dropdown.innerHTML = '<option value="">Select District</option>';
                        districts.forEach(district => {
                            const option = document.createElement('option');
                            option.value = district;
                            option.textContent = district;
                            dropdown.appendChild(option);
                        });
                    }
                });
            }

            // --- CRUD HELPERS ---
            function generateNewId(key) {
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                const prefix = key === SUPERVISOR_KEY ? 'sup-' : 
                               key === FIELD_OFFICER_KEY ? 'fo-' :
                               key === VENN_OFFICER_KEY ? 'vo-' :
                               key === DATA_COLLECTOR_KEY ? 'dc-' : 'adm-';
                const count = data.length + 1;
                return `${prefix}${count}-${Date.now() % 1000}`; // Added timestamp to reduce collisions
            }

            function createUserObject(id, name, empId, email, phone, username, password, role, district, status) {
                 const keyMap = {
                    'supervisor': SUPERVISOR_KEY,
                    'field_officer': FIELD_OFFICER_KEY,
                    'venn_officer': VENN_OFFICER_KEY,
                    'data_collector': DATA_COLLECTOR_KEY
                };
                const storageKey = keyMap[role] || DATA_COLLECTOR_KEY;

                return {
                    id: id || generateNewId(storageKey),
                    name,
                    empId,
                    email,
                    phone,
                    username,
                    password: password || 'default', // Only hash/salt if this were a real backend
                    role,
                    district,
                    status: status || 'active'
                };
            }

            // --- SUPERVISOR LOGIC ---
            function renderSupervisorsTable(searchTerm = '') {
                const data = getSupervisorData().filter(s => 
                    s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.empId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.district.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const tbody = document.getElementById('supervisorsTableBody');
                tbody.innerHTML = data.map(s => `
                    <tr data-id="${s.id}">
                        <td><input type="checkbox" class="supervisor-checkbox" value="${s.id}"></td>
                        <td>
                            <strong>${s.name}</strong> (${s.empId})<br>
                            <small>${s.username}</small>
                        </td>
                        <td>${s.email}<br>${s.phone}</td>
                        <td>${getDistrictName(s.district)}</td>
                        <td><span class="badge badge-${s.status === 'active' ? 'success' : 'warning'}">${s.status.toUpperCase()}</span></td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline edit-supervisor-btn" data-id="${s.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-supervisor-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                toggleBulkSupervisorDeleteButton();
            }

            function setupSupervisorEventListeners() {
                document.getElementById('addSupervisorBtn').addEventListener('click', () => openSupervisorModal());
                document.getElementById('supervisorSearchInput').addEventListener('input', (e) => renderSupervisorsTable(e.target.value));
                document.getElementById('supervisorForm').addEventListener('submit', handleSupervisorFormSubmit);
                document.getElementById('supervisorsTableBody').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-supervisor-btn')) editSupervisor(e.target.closest('.edit-supervisor-btn').dataset.id);
                    if (e.target.closest('.delete-supervisor-btn')) deleteSupervisor(e.target.closest('.delete-supervisor-btn').dataset.id);
                });
                document.getElementById('selectAllSupervisors').addEventListener('change', (e) => {
                    document.querySelectorAll('.supervisor-checkbox').forEach(cb => cb.checked = e.target.checked);
                    toggleBulkSupervisorDeleteButton();
                });
                document.getElementById('supervisorsTableBody').addEventListener('change', (e) => {
                    if (e.target.classList.contains('supervisor-checkbox')) toggleBulkSupervisorDeleteButton();
                });
                document.getElementById('bulkDeleteSupervisorsBtn').addEventListener('click', bulkDeleteSupervisors);
            }
            
            function openSupervisorModal(id = null) {
                clearForm('supervisorForm');
                const modal = document.getElementById('supervisorModal');
                const title = document.getElementById('supervisorModalTitle');
                const saveBtn = document.getElementById('saveSupervisorBtn');
                
                if (id) {
                    const supervisor = getSupervisorData().find(s => s.id === id);
                    if (supervisor) {
                        title.textContent = 'Edit Supervisor';
                        document.getElementById('supervisorId').value = id;
                        document.getElementById('supervisorName').value = supervisor.name;
                        document.getElementById('supervisorEmpId').value = supervisor.empId;
                        document.getElementById('supervisorEmail').value = supervisor.email;
                        document.getElementById('supervisorPhone').value = supervisor.phone;
                        document.getElementById('supervisorUsername').value = supervisor.username;
                        document.getElementById('supervisorPassword').required = false;
                        document.getElementById('supervisorDistrict').value = supervisor.district;
                        document.getElementById('supervisorStatus').value = supervisor.status;
                        saveBtn.textContent = 'Save Changes';
                    }
                } else {
                    title.textContent = 'Add New Supervisor';
                    document.getElementById('supervisorPassword').required = true;
                    saveBtn.textContent = 'Save Supervisor';
                }
                modal.style.display = 'flex';
            }
            
            function handleSupervisorFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('supervisorId').value;
                const name = document.getElementById('supervisorName').value.trim();
                const empId = document.getElementById('supervisorEmpId').value.trim();
                const email = document.getElementById('supervisorEmail').value.trim();
                const phone = document.getElementById('supervisorPhone').value.trim();
                const username = document.getElementById('supervisorUsername').value.trim();
                const password = document.getElementById('supervisorPassword').value;
                const district = document.getElementById('supervisorDistrict').value;
                const status = document.getElementById('supervisorStatus').value;
                
                let supervisors = getSupervisorData();
                
                if (id) {
                    // Edit existing
                    const index = supervisors.findIndex(s => s.id === id);
                    if (index > -1) {
                        supervisors[index].name = name;
                        supervisors[index].empId = empId;
                        supervisors[index].email = email;
                        supervisors[index].phone = phone;
                        supervisors[index].username = username;
                        if (password) supervisors[index].password = password;
                        supervisors[index].district = district;
                        supervisors[index].status = status;
                        showAlert('supervisorAlert', 'success', `Supervisor ${name} updated successfully.`);
                    }
                } else {
                    // Add new
                    const newSupervisor = createUserObject(null, name, empId, email, phone, username, password, 'supervisor', district, status);
                    supervisors.push(newSupervisor);
                    showAlert('supervisorAlert', 'success', `Supervisor ${name} added successfully.`);
                }
                
                saveSupervisorData(supervisors);
                document.getElementById('supervisorModal').style.display = 'none';
                renderSupervisorsTable();
            }

            function editSupervisor(id) { openSupervisorModal(id); }
            function deleteSupervisor(id) {
                if (confirm('Are you sure you want to delete this Supervisor account?')) {
                    let supervisors = getSupervisorData().filter(s => s.id !== id);
                    saveSupervisorData(supervisors);
                    showAlert('supervisorAlert', 'success', `Supervisor account ${id} deleted.`);
                    renderSupervisorsTable();
                }
            }
            function toggleBulkSupervisorDeleteButton() {
                const checkedCount = document.querySelectorAll('.supervisor-checkbox:checked').length;
                document.getElementById('bulkDeleteSupervisorsBtn').style.display = checkedCount > 0 ? 'inline-flex' : 'none';
                document.getElementById('bulkDeleteSupervisorsBtn').textContent = `Delete Selected (${checkedCount})`;
            }
            function bulkDeleteSupervisors() {
                const selectedIds = Array.from(document.querySelectorAll('.supervisor-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0 || !confirm(`Are you sure you want to delete ${selectedIds.length} selected Supervisor accounts?`)) return;
                
                let supervisors = getSupervisorData().filter(s => !selectedIds.includes(s.id));
                saveSupervisorData(supervisors);
                showAlert('supervisorAlert', 'success', `${selectedIds.length} Supervisor accounts deleted.`);
                renderSupervisorsTable();
            }

            // --- FIELD OFFICER LOGIC ---
            function renderFieldOfficersTable(searchTerm = '') {
                const data = getFieldOfficerData().filter(s => 
                    s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.empId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.district.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const tbody = document.getElementById('fieldOfficersTableBody');
                tbody.innerHTML = data.map(s => `
                    <tr data-id="${s.id}">
                        <td><input type="checkbox" class="field-officer-checkbox" value="${s.id}"></td>
                        <td>
                            <strong>${s.name}</strong> (${s.empId})<br>
                            <small>${s.username}</small>
                        </td>
                        <td>${s.email}<br>${s.phone}</td>
                        <td>${getDistrictName(s.district)}</td>
                        <td><span class="badge badge-${s.status === 'active' ? 'success' : 'warning'}">${s.status.toUpperCase()}</span></td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline edit-field-officer-btn" data-id="${s.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-field-officer-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                toggleBulkFieldOfficerDeleteButton();
            }

            function setupFieldOfficerEventListeners() {
                document.getElementById('addFieldOfficerBtn').addEventListener('click', () => openFieldOfficerModal());
                document.getElementById('fieldOfficerSearchInput').addEventListener('input', (e) => renderFieldOfficersTable(e.target.value));
                document.getElementById('fieldOfficerForm').addEventListener('submit', handleFieldOfficerFormSubmit);
                document.getElementById('fieldOfficersTableBody').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-field-officer-btn')) editFieldOfficer(e.target.closest('.edit-field-officer-btn').dataset.id);
                    if (e.target.closest('.delete-field-officer-btn')) deleteFieldOfficer(e.target.closest('.delete-field-officer-btn').dataset.id);
                });
                document.getElementById('selectAllFieldOfficers').addEventListener('change', (e) => {
                    document.querySelectorAll('.field-officer-checkbox').forEach(cb => cb.checked = e.target.checked);
                    toggleBulkFieldOfficerDeleteButton();
                });
                document.getElementById('fieldOfficersTableBody').addEventListener('change', (e) => {
                    if (e.target.classList.contains('field-officer-checkbox')) toggleBulkFieldOfficerDeleteButton();
                });
                document.getElementById('bulkDeleteFieldOfficersBtn').addEventListener('click', bulkDeleteFieldOfficers);
            }
            
            function openFieldOfficerModal(id = null) {
                clearForm('fieldOfficerForm');
                const modal = document.getElementById('fieldOfficerModal');
                const title = document.getElementById('fieldOfficerModalTitle');
                const saveBtn = document.getElementById('saveFieldOfficerBtn');
                
                if (id) {
                    const officer = getFieldOfficerData().find(s => s.id === id);
                    if (officer) {
                        title.textContent = 'Edit Field Officer';
                        document.getElementById('fieldOfficerId').value = id;
                        document.getElementById('fieldOfficerName').value = officer.name;
                        document.getElementById('fieldOfficerEmpId').value = officer.empId;
                        document.getElementById('fieldOfficerEmail').value = officer.email;
                        document.getElementById('fieldOfficerPhone').value = officer.phone;
                        document.getElementById('fieldOfficerUsername').value = officer.username;
                        document.getElementById('fieldOfficerPassword').required = false;
                        document.getElementById('fieldOfficerDistrict').value = officer.district;
                        document.getElementById('fieldOfficerStatus').value = officer.status;
                        saveBtn.textContent = 'Save Changes';
                    }
                } else {
                    title.textContent = 'Add New Field Officer';
                    document.getElementById('fieldOfficerPassword').required = true;
                    saveBtn.textContent = 'Save Field Officer';
                }
                modal.style.display = 'flex';
            }
            
            function handleFieldOfficerFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('fieldOfficerId').value;
                const name = document.getElementById('fieldOfficerName').value.trim();
                const empId = document.getElementById('fieldOfficerEmpId').value.trim();
                const email = document.getElementById('fieldOfficerEmail').value.trim();
                const phone = document.getElementById('fieldOfficerPhone').value.trim();
                const username = document.getElementById('fieldOfficerUsername').value.trim();
                const password = document.getElementById('fieldOfficerPassword').value;
                const district = document.getElementById('fieldOfficerDistrict').value;
                const status = document.getElementById('fieldOfficerStatus').value;
                
                let officers = getFieldOfficerData();
                
                if (id) {
                    const index = officers.findIndex(s => s.id === id);
                    if (index > -1) {
                        officers[index].name = name;
                        officers[index].empId = empId;
                        officers[index].email = email;
                        officers[index].phone = phone;
                        officers[index].username = username;
                        if (password) officers[index].password = password;
                        officers[index].district = district;
                        officers[index].status = status;
                        showAlert('fieldOfficerAlert', 'success', `Field Officer ${name} updated successfully.`);
                    }
                } else {
                    const newOfficer = createUserObject(null, name, empId, email, phone, username, password, 'field_officer', district, status);
                    officers.push(newOfficer);
                    showAlert('fieldOfficerAlert', 'success', `Field Officer ${name} added successfully.`);
                }
                
                saveFieldOfficerData(officers);
                document.getElementById('fieldOfficerModal').style.display = 'none';
                renderFieldOfficersTable();
            }

            function editFieldOfficer(id) { openFieldOfficerModal(id); }
            function deleteFieldOfficer(id) {
                if (confirm('Are you sure you want to delete this Field Officer account?')) {
                    let officers = getFieldOfficerData().filter(s => s.id !== id);
                    saveFieldOfficerData(officers);
                    showAlert('fieldOfficerAlert', 'success', `Field Officer account ${id} deleted.`);
                    renderFieldOfficersTable();
                }
            }
            function toggleBulkFieldOfficerDeleteButton() {
                const checkedCount = document.querySelectorAll('.field-officer-checkbox:checked').length;
                document.getElementById('bulkDeleteFieldOfficersBtn').style.display = checkedCount > 0 ? 'inline-flex' : 'none';
                document.getElementById('bulkDeleteFieldOfficersBtn').textContent = `Delete Selected (${checkedCount})`;
            }
            function bulkDeleteFieldOfficers() {
                const selectedIds = Array.from(document.querySelectorAll('.field-officer-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0 || !confirm(`Are you sure you want to delete ${selectedIds.length} selected Field Officer accounts?`)) return;
                
                let officers = getFieldOfficerData().filter(s => !selectedIds.includes(s.id));
                saveFieldOfficerData(officers);
                showAlert('fieldOfficerAlert', 'success', `${selectedIds.length} Field Officer accounts deleted.`);
                renderFieldOfficersTable();
            }
            
            // --- VENN OFFICER LOGIC (NEW) ---
            function renderVennOfficersTable(searchTerm = '') {
                const data = getVennOfficerData().filter(s => 
                    s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.empId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.district.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const tbody = document.getElementById('vennOfficersTableBody');
                tbody.innerHTML = data.map(s => `
                    <tr data-id="${s.id}">
                        <td><input type="checkbox" class="venn-officer-checkbox" value="${s.id}"></td>
                        <td>
                            <strong>${s.name}</strong> (${s.empId})<br>
                            <small>${s.username}</small>
                        </td>
                        <td>${s.email}<br>${s.phone}</td>
                        <td>${getDistrictName(s.district)}</td>
                        <td><span class="badge badge-${s.status === 'active' ? 'success' : 'warning'}">${s.status.toUpperCase()}</span></td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline edit-venn-officer-btn" data-id="${s.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-venn-officer-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                toggleBulkVennOfficerDeleteButton();
            }

            function setupVennOfficerEventListeners() {
                document.getElementById('addVennOfficerBtn').addEventListener('click', () => openVennOfficerModal());
                document.getElementById('vennOfficerSearchInput').addEventListener('input', (e) => renderVennOfficersTable(e.target.value));
                document.getElementById('vennOfficerForm').addEventListener('submit', handleVennOfficerFormSubmit);
                document.getElementById('vennOfficersTableBody').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-venn-officer-btn')) editVennOfficer(e.target.closest('.edit-venn-officer-btn').dataset.id);
                    if (e.target.closest('.delete-venn-officer-btn')) deleteVennOfficer(e.target.closest('.delete-venn-officer-btn').dataset.id);
                });
                document.getElementById('selectAllVennOfficers').addEventListener('change', (e) => {
                    document.querySelectorAll('.venn-officer-checkbox').forEach(cb => cb.checked = e.target.checked);
                    toggleBulkVennOfficerDeleteButton();
                });
                document.getElementById('vennOfficersTableBody').addEventListener('change', (e) => {
                    if (e.target.classList.contains('venn-officer-checkbox')) toggleBulkVennOfficerDeleteButton();
                });
                document.getElementById('bulkDeleteVennOfficersBtn').addEventListener('click', bulkDeleteVennOfficers);
            }
            
            function openVennOfficerModal(id = null) {
                clearForm('vennOfficerForm');
                const modal = document.getElementById('vennOfficerModal');
                const title = document.getElementById('vennOfficerModalTitle');
                const saveBtn = document.getElementById('saveVennOfficerBtn');
                
                if (id) {
                    const officer = getVennOfficerData().find(s => s.id === id);
                    if (officer) {
                        title.textContent = 'Edit Venn Officer';
                        document.getElementById('vennOfficerId').value = id;
                        document.getElementById('vennOfficerName').value = officer.name;
                        document.getElementById('vennOfficerEmpId').value = officer.empId;
                        document.getElementById('vennOfficerEmail').value = officer.email;
                        document.getElementById('vennOfficerPhone').value = officer.phone;
                        document.getElementById('vennOfficerUsername').value = officer.username;
                        document.getElementById('vennOfficerPassword').required = false;
                        document.getElementById('vennOfficerDistrict').value = officer.district;
                        document.getElementById('vennOfficerStatus').value = officer.status;
                        saveBtn.textContent = 'Save Changes';
                    }
                } else {
                    title.textContent = 'Add New Venn Officer';
                    document.getElementById('vennOfficerPassword').required = true;
                    saveBtn.textContent = 'Save Venn Officer';
                }
                modal.style.display = 'flex';
            }
            
            function handleVennOfficerFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('vennOfficerId').value;
                const name = document.getElementById('vennOfficerName').value.trim();
                const empId = document.getElementById('vennOfficerEmpId').value.trim();
                const email = document.getElementById('vennOfficerEmail').value.trim();
                const phone = document.getElementById('vennOfficerPhone').value.trim();
                const username = document.getElementById('vennOfficerUsername').value.trim();
                const password = document.getElementById('vennOfficerPassword').value;
                const district = document.getElementById('vennOfficerDistrict').value;
                const status = document.getElementById('vennOfficerStatus').value;
                
                let officers = getVennOfficerData();
                
                if (id) {
                    const index = officers.findIndex(s => s.id === id);
                    if (index > -1) {
                        officers[index].name = name;
                        officers[index].empId = empId;
                        officers[index].email = email;
                        officers[index].phone = phone;
                        officers[index].username = username;
                        if (password) officers[index].password = password;
                        officers[index].district = district;
                        officers[index].status = status;
                        showAlert('vennOfficerAlert', 'success', `Venn Officer ${name} updated successfully.`);
                    }
                } else {
                    const newOfficer = createUserObject(null, name, empId, email, phone, username, password, 'venn_officer', district, status);
                    officers.push(newOfficer);
                    showAlert('vennOfficerAlert', 'success', `Venn Officer ${name} added successfully.`);
                }
                
                saveVennOfficerData(officers);
                document.getElementById('vennOfficerModal').style.display = 'none';
                renderVennOfficersTable();
            }

            function editVennOfficer(id) { openVennOfficerModal(id); }
            function deleteVennOfficer(id) {
                if (confirm('Are you sure you want to delete this Venn Officer account?')) {
                    let officers = getVennOfficerData().filter(s => s.id !== id);
                    saveVennOfficerData(officers);
                    showAlert('vennOfficerAlert', 'success', `Venn Officer account ${id} deleted.`);
                    renderVennOfficersTable();
                }
            }
            function toggleBulkVennOfficerDeleteButton() {
                const checkedCount = document.querySelectorAll('.venn-officer-checkbox:checked').length;
                document.getElementById('bulkDeleteVennOfficersBtn').style.display = checkedCount > 0 ? 'inline-flex' : 'none';
                document.getElementById('bulkDeleteVennOfficersBtn').textContent = `Delete Selected (${checkedCount})`;
            }
            function bulkDeleteVennOfficers() {
                const selectedIds = Array.from(document.querySelectorAll('.venn-officer-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0 || !confirm(`Are you sure you want to delete ${selectedIds.length} selected Venn Officer accounts?`)) return;
                
                let officers = getVennOfficerData().filter(s => !selectedIds.includes(s.id));
                saveVennOfficerData(officers);
                showAlert('vennOfficerAlert', 'success', `${selectedIds.length} Venn Officer accounts deleted.`);
                renderVennOfficersTable();
            }
            // --- END VENN OFFICER LOGIC ---

            // --- DATA COLLECTOR LOGIC ---
            function renderDataCollectorsTable(searchTerm = '') {
                const data = getDataCollectorData().filter(s => 
                    s.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.empId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.district.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const tbody = document.getElementById('dataCollectorsTableBody');
                tbody.innerHTML = data.map(s => `
                    <tr data-id="${s.id}">
                        <td><input type="checkbox" class="data-collector-checkbox" value="${s.id}"></td>
                        <td>
                            <strong>${s.name}</strong> (${s.empId})<br>
                            <small>${s.username}</small>
                        </td>
                        <td>${s.email}<br>${s.phone}</td>
                        <td>${getDistrictName(s.district)}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline edit-data-collector-btn" data-id="${s.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-data-collector-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
                toggleBulkDataCollectorDeleteButton();
            }

            function setupDataCollectorEventListeners() {
                document.getElementById('addDataCollectorBtn').addEventListener('click', () => openDataCollectorModal());
                document.getElementById('dataCollectorSearchInput').addEventListener('input', (e) => renderDataCollectorsTable(e.target.value));
                document.getElementById('dataCollectorForm').addEventListener('submit', handleDataCollectorFormSubmit);
                document.getElementById('dataCollectorsTableBody').addEventListener('click', (e) => {
                    if (e.target.closest('.edit-data-collector-btn')) editDataCollector(e.target.closest('.edit-data-collector-btn').dataset.id);
                    if (e.target.closest('.delete-data-collector-btn')) deleteDataCollector(e.target.closest('.delete-data-collector-btn').dataset.id);
                });
                document.getElementById('selectAllDataCollectors').addEventListener('change', (e) => {
                    document.querySelectorAll('.data-collector-checkbox').forEach(cb => cb.checked = e.target.checked);
                    toggleBulkDataCollectorDeleteButton();
                });
                document.getElementById('dataCollectorsTableBody').addEventListener('change', (e) => {
                    if (e.target.classList.contains('data-collector-checkbox')) toggleBulkDataCollectorDeleteButton();
                });
                document.getElementById('bulkDeleteDataCollectorsBtn').addEventListener('click', bulkDeleteDataCollectors);
                // REMOVED: Old bulk upload listener, now handled in initializeApp
            }
            
            function openDataCollectorModal(id = null) {
                clearForm('dataCollectorForm');
                const modal = document.getElementById('dataCollectorModal');
                const title = document.getElementById('dataCollectorModalTitle');
                const saveBtn = document.getElementById('saveDataCollectorBtn');
                
                if (id) {
                    const collector = getDataCollectorData().find(s => s.id === id);
                    if (collector) {
                        title.textContent = 'Edit Data Collector';
                        document.getElementById('dataCollectorId').value = id;
                        document.getElementById('dataCollectorName').value = collector.name;
                        document.getElementById('dataCollectorEmpId').value = collector.empId;
                        document.getElementById('dataCollectorEmail').value = collector.email;
                        document.getElementById('dataCollectorPhone').value = collector.phone;
                        document.getElementById('dataCollectorUsername').value = collector.username;
                        document.getElementById('dataCollectorPassword').required = false;
                        document.getElementById('dataCollectorDistrict').value = collector.district;
                        saveBtn.textContent = 'Save Changes';
                    }
                } else {
                    title.textContent = 'Add New Data Collector';
                    document.getElementById('dataCollectorPassword').required = true;
                    saveBtn.textContent = 'Save Collector';
                }
                modal.style.display = 'flex';
            }
            
            function handleDataCollectorFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('dataCollectorId').value;
                const name = document.getElementById('dataCollectorName').value.trim();
                const empId = document.getElementById('dataCollectorEmpId').value.trim();
                const email = document.getElementById('dataCollectorEmail').value.trim();
                const phone = document.getElementById('dataCollectorPhone').value.trim();
                const username = document.getElementById('dataCollectorUsername').value.trim();
                const password = document.getElementById('dataCollectorPassword').value;
                const district = document.getElementById('dataCollectorDistrict').value;
                
                let collectors = getDataCollectorData();
                
                if (id) {
                    const index = collectors.findIndex(s => s.id === id);
                    if (index > -1) {
                        collectors[index].name = name;
                        collectors[index].empId = empId;
                        collectors[index].email = email;
                        collectors[index].phone = phone;
                        collectors[index].username = username;
                        if (password) collectors[index].password = password;
                        collectors[index].district = district;
                        showAlert('dataCollectorAlert', 'success', `Data Collector ${name} updated successfully.`);
                    }
                } else {
                    const newCollector = createUserObject(null, name, empId, email, phone, username, password, 'data_collector', district);
                    collectors.push(newCollector);
                    showAlert('dataCollectorAlert', 'success', `Data Collector ${name} added successfully.`);
                }
                
                saveDataCollectorData(collectors);
                document.getElementById('dataCollectorModal').style.display = 'none';
                renderDataCollectorsTable();
            }

            function editDataCollector(id) { openDataCollectorModal(id); }
            function deleteDataCollector(id) {
                if (confirm('Are you sure you want to delete this Data Collector account?')) {
                    let collectors = getDataCollectorData().filter(s => s.id !== id);
                    saveDataCollectorData(collectors);
                    showAlert('dataCollectorAlert', 'success', `Data Collector account ${id} deleted.`);
                    renderDataCollectorsTable();
                }
            }
            function toggleBulkDataCollectorDeleteButton() {
                const checkedCount = document.querySelectorAll('.data-collector-checkbox:checked').length;
                document.getElementById('bulkDeleteDataCollectorsBtn').style.display = checkedCount > 0 ? 'inline-flex' : 'none';
                document.getElementById('bulkDeleteDataCollectorsBtn').textContent = `Delete Selected (${checkedCount})`;
            }
            function bulkDeleteDataCollectors() {
                const selectedIds = Array.from(document.querySelectorAll('.data-collector-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length === 0 || !confirm(`Are you sure you want to delete ${selectedIds.length} selected Data Collector accounts?`)) return;
                
                let collectors = getDataCollectorData().filter(s => !selectedIds.includes(s.id));
                saveDataCollectorData(collectors);
                showAlert('dataCollectorAlert', 'success', `${selectedIds.length} Data Collector accounts deleted.`);
                renderDataCollectorsTable();
            }
            
            // --- BULK UPLOAD LOGIC (REFACTORED) ---

            // --- Template Download Functions ---
            function downloadCollectorTemplate() {
                const template = [
                    { "Name": "", "Employee_ID": "", "Email": "", "Phone": "", "Username": "", "Password": "", "District": "" }
                ];
                downloadCSV(template, 'data_collector_template.csv');
            }
            
            function downloadSupervisorTemplate() {
                const template = [
                    { "Name": "", "Employee_ID": "", "Email": "", "Phone": "", "Username": "", "Password": "", "District": "", "Status": "active" }
                ];
                downloadCSV(template, 'supervisor_template.csv');
            }
            function downloadFieldOfficerTemplate() {
                const template = [
                    { "Name": "", "Employee_ID": "", "Email": "", "Phone": "", "Username": "", "Password": "", "District": "", "Status": "active" }
                ];
                downloadCSV(template, 'field_officer_template.csv');
            }
            function downloadVennOfficerTemplate() {
                const template = [
                    { "Name": "", "Employee_ID": "", "Email": "", "Phone": "", "Username": "", "Password": "", "District": "", "Status": "active" }
                ];
                downloadCSV(template, 'venn_officer_template.csv');
            }
            
            // --- Modal Opener ---
            function openBulkUploadModal(uploadType) {
                const modal = document.getElementById('bulkUploadModal');
                const title = document.getElementById('bulkUploadModalTitle');
                const downloadBtn = document.getElementById('downloadTemplateBtn');
                
                modal.dataset.uploadType = uploadType; // Store the type

                switch(uploadType) {
                    case 'supervisor':
                        title.textContent = 'Bulk Upload Supervisors';
                        downloadBtn.onclick = downloadSupervisorTemplate;
                        break;
                    case 'fieldOfficer':
                        title.textContent = 'Bulk Upload Field Officers';
                        downloadBtn.onclick = downloadFieldOfficerTemplate;
                        break;
                    case 'vennOfficer':
                        title.textContent = 'Bulk Upload Venn Officers';
                        downloadBtn.onclick = downloadVennOfficerTemplate;
                        break;
                    case 'dataCollector':
                    default:
                        title.textContent = 'Bulk Upload Data Collectors';
                        downloadBtn.onclick = downloadCollectorTemplate;
                        break;
                }
                
                modal.style.display = 'flex';
                document.getElementById('upload-preview').style.display = 'none';
                document.getElementById('collectorFileUpload').value = ''; // Use the same file input
                document.getElementById('processBulkUploadBtn').disabled = true;
                uploadedUserData = []; // Clear any previous data
            }

            // --- File Preview Logic ---
            document.getElementById('collectorFileUpload').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const uploadPreview = document.getElementById('upload-preview');
                const confirmUploadBtn = document.getElementById('processBulkUploadBtn');
                
                uploadPreview.style.display = 'block';
                uploadPreview.innerHTML = '<h4>File Preview:</h4><p>Processing file...</p>';
                confirmUploadBtn.disabled = true;

                const reader = new FileReader();
                reader.onload = function(e) {
                    let data = e.target.result;
                    let fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (fileExtension === 'csv') {
                        Papa.parse(data, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                if (results.errors.length > 0) {
                                    console.error("CSV Parsing errors:", results.errors);
                                    uploadPreview.innerHTML += '<p style="color:red;">Error parsing CSV file. Please check the file format and console for details.</p>';
                                    return;
                                }
                                uploadedUserData = results.data;
                                previewUpload(uploadedUserData);
                            }
                        });
                    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        const workbook = XLSX.read(data, {type: 'binary'});
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        let jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        
                        if (jsonData.length > 0) {
                            const headers = jsonData[0].map(h => String(h).trim().replace(/\s/g, '_')); // Sanitize headers
                            uploadedUserData = jsonData.slice(1).map(row => {
                                let obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index];
                                });
                                return obj;
                            });
                        }
                        previewUpload(uploadedUserData);
                    } else {
                        showAlert('dataCollectorAlert', 'error', 'Unsupported file type. Please upload a CSV or XLSX file.');
                        uploadPreview.style.display = 'none';
                    }
                };
                reader.readAsBinaryString(file);
            });

            function previewUpload(data) {
                const previewDiv = document.getElementById('upload-preview');
                const table = document.getElementById('preview-table');
                table.innerHTML = '';
                
                if (data.length === 0) {
                    previewDiv.style.display = 'none';
                    document.getElementById('processBulkUploadBtn').disabled = true;
                    return;
                }
                
                const headers = Object.keys(data[0]);
                const thead = table.createTHead();
                const hRow = thead.insertRow();
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.replace(/_/g, ' ');
                    hRow.appendChild(th);
                });
                
                const tbody = table.createTBody();
                data.slice(0, 5).forEach(rowObj => {
                    const r = tbody.insertRow();
                    headers.forEach(header => {
                        const cell = r.insertCell();
                        cell.textContent = rowObj[header] || '-';
                    });
                });

                previewDiv.style.display = 'block';
                document.getElementById('processBulkUploadBtn').disabled = false;
            }

            // --- File Processing Logic ---
            document.getElementById('processBulkUploadBtn').addEventListener('click', handleProcessBulkUpload);

            function handleProcessBulkUpload() {
                const uploadType = document.getElementById('bulkUploadModal').dataset.uploadType;
                
                if (uploadType === 'supervisor') {
                    processUserUpload(getSupervisorData, saveSupervisorData, 'supervisorAlert', 'Supervisor', 'supervisor', renderSupervisorsTable, true);
                } else if (uploadType === 'fieldOfficer') {
                    processUserUpload(getFieldOfficerData, saveFieldOfficerData, 'fieldOfficerAlert', 'Field Officer', 'field_officer', renderFieldOfficersTable, true);
                } else if (uploadType === 'vennOfficer') {
                    processUserUpload(getVennOfficerData, saveVennOfficerData, 'vennOfficerAlert', 'Venn Officer', 'venn_officer', renderVennOfficersTable, true);
                } else if (uploadType === 'dataCollector') {
                    processUserUpload(getDataCollectorData, saveDataCollectorData, 'dataCollectorAlert', 'Data Collector', 'data_collector', renderDataCollectorsTable, false);
                }
            }
            
            function processUserUpload(getDataFunc, saveDataFunc, alertId, userRoleName, userRoleKey, renderFunc, hasStatus) {
                let users = getDataFunc();
                const existingEmpIds = new Set(users.map(c => c.empId));
                const existingUsernames = new Set(users.map(c => c.username));
                const validDistricts = new Set(getDistrictData().map(d => d.name));

                let addedCount = 0;
                let skippedCount = 0;

                // uploadedUserData is the global var holding the parsed file
                uploadedUserData.forEach(row => {
                    // Find keys in a case-insensitive way from the parsed file
                    let nameKey, empIdKey, emailKey, phoneKey, usernameKey, passwordKey, districtKey, statusKey;
                    for (const key in row) {
                        const lowerKey = key.toLowerCase();
                        if (lowerKey.includes('name')) nameKey = key;
                        if (lowerKey.includes('employee_id')) empIdKey = key;
                        if (lowerKey.includes('email')) emailKey = key;
                        if (lowerKey.includes('phone')) phoneKey = key;
                        if (lowerKey.includes('username')) usernameKey = key;
                        if (lowerKey.includes('password')) passwordKey = key;
                        if (lowerKey.includes('district')) districtKey = key;
                        if (lowerKey.includes('status')) statusKey = key;
                    }

                    const name = row[nameKey] ? row[nameKey].trim() : '';
                    const empId = row[empIdKey] ? row[empIdKey].trim() : '';
                    const email = row[emailKey] ? row[emailKey].trim() : '';
                    const phone = row[phoneKey] ? String(row[phoneKey]).trim() : '';
                    const username = row[usernameKey] ? row[usernameKey].trim() : '';
                    const password = row[passwordKey] ? row[passwordKey].trim() : 'password';
                    const district = row[districtKey] ? row[districtKey].trim() : '';
                    
                    let status = 'active';
                    if (hasStatus && row[statusKey]) {
                        status = row[statusKey] ? row[statusKey].trim().toLowerCase() : 'active';
                        if (status !== 'active' && status !== 'inactive') status = 'active';
                    }

                    if (!name || !empId || !email || !username || !district || !validDistricts.has(district) || existingEmpIds.has(empId) || existingUsernames.has(username)) {
                        skippedCount++;
                        return;
                    }

                    const newUser = createUserObject(null, name, empId, email, phone, username, password, userRoleKey, district, status);
                    users.push(newUser);
                    existingEmpIds.add(empId);
                    existingUsernames.add(username);
                    addedCount++;
                });

                saveDataFunc(users);
                showAlert(alertId, 'success', `Added ${addedCount} ${userRoleName}(s). Skipped ${skippedCount} (missing data, duplicate ID/username, or invalid district).`);
                renderFunc();
                document.getElementById('bulkUploadModal').style.display = 'none';
                
                // Clear global upload data
                uploadedUserData = [];
            }
            // --- END BULK UPLOAD LOGIC ---

            // --- ADMIN LOGIC ---
            function renderAdminsTable() {
                const data = getAdminData();
                const tbody = document.getElementById('adminsTableBody');
                tbody.innerHTML = data.map(a => `
                    <tr data-id="${a.id}">
                        <td><strong>${a.username}</strong></td>
                        <td>${a.role.toUpperCase()}</td>
                        <td class="table-actions">
                            ${a.username !== 'admin' ? 
                                `<button class="btn btn-sm btn-danger delete-admin-btn" data-id="${a.id}"><i class="fas fa-trash"></i> Delete</button>`
                                : 'Primary Account'}
                        </td>
                    </tr>
                `).join('');
            }

            function setupAdminEventListeners() {
                document.getElementById('addAdminBtn').addEventListener('click', () => openAdminModal());
                document.getElementById('adminForm').addEventListener('submit', handleAdminFormSubmit);
                document.getElementById('adminsTableBody').addEventListener('click', (e) => {
                    if (e.target.closest('.delete-admin-btn')) deleteAdmin(e.target.closest('.delete-admin-btn').dataset.id);
                });
            }

            function openAdminModal(id = null) {
                clearForm('adminForm');
                const modal = document.getElementById('adminModal');
                const title = document.getElementById('adminModalTitle');
                const saveBtn = document.getElementById('saveAdminBtn');
                
                if (id) {
                    const admin = getAdminData().find(a => a.id === id);
                    if (admin) {
                        title.textContent = 'Edit Admin';
                        document.getElementById('adminId').value = id;
                        document.getElementById('adminName').value = admin.name;
                        document.getElementById('adminEmpId').value = admin.empId || '';
                        document.getElementById('adminUsername').value = admin.username;
                        document.getElementById('adminPassword').required = false;
                        saveBtn.textContent = 'Save Changes';
                    }
                } else {
                    title.textContent = 'Add New Admin';
                    document.getElementById('adminPassword').required = true;
                    saveBtn.textContent = 'Save Admin';
                }
                modal.style.display = 'flex';
            }

            function handleAdminFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('adminId').value;
                const name = document.getElementById('adminName').value.trim();
                const empId = document.getElementById('adminEmpId').value.trim();
                const username = document.getElementById('adminUsername').value.trim();
                const password = document.getElementById('adminPassword').value;

                let admins = getAdminData();

                if (id) {
                    const index = admins.findIndex(a => a.id === id);
                    if (index > -1) {
                        admins[index].name = name;
                        admins[index].empId = empId;
                        admins[index].username = username;
                        if (password) admins[index].password = password;
                        showAlert('adminAccountsAlert', 'success', `Admin ${name} updated successfully.`);
                    }
                } else {
                    const newAdmin = { 
                        id: generateNewId(ADMIN_KEY), 
                        name, 
                        empId, 
                        username, 
                        password: password || 'password', 
                        role: 'admin' 
                    };
                    admins.push(newAdmin);
                    showAlert('adminAccountsAlert', 'success', `Admin ${name} added successfully.`);
                }

                saveAdminData(admins);
                document.getElementById('adminModal').style.display = 'none';
                renderAdminsTable();
            }

            function deleteAdmin(id) {
                if (confirm('Are you sure you want to delete this Admin account? (Only the primary "admin" account is protected)')) {
                    let admins = getAdminData().filter(a => a.id !== id);
                    saveAdminData(admins);
                    showAlert('adminAccountsAlert', 'success', `Admin account deleted.`);
                    renderAdminsTable();
                }
            }

            // --- DISTRICT LOGIC ---
            function renderDistrictsTable() {
                const districts = getDistrictData();
                const inventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
                const supervisors = getSupervisorData();
                const fieldOfficers = getFieldOfficerData();
                const vennOfficers = getVennOfficerData(); // NEW
                const dataCollectors = getDataCollectorData();
                
                const allUsers = [...supervisors, ...fieldOfficers, ...vennOfficers, ...dataCollectors];
                
                const tbody = document.getElementById('districtsTableBody');
                tbody.innerHTML = districts.map(d => {
                    const assignedUsers = allUsers.filter(u => u.district === d.name).length;
                    const inventoryCount = inventory.filter(i => i.district === d.name).length;
                    
                    return `
                        <tr data-id="${d.id}">
                            <td><strong>${d.name}</strong></td>
                            <td>${d.country}</td>
                            <td>${assignedUsers} users, ${inventoryCount} items</td>
                            <td class="table-actions">
                                <!-- UPDATED: Delete button now uses district name -->
                                <button class="btn btn-sm btn-danger delete-district-btn" data-name="${d.name}" ${assignedUsers > 0 || inventoryCount > 0 ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('addDistrictForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('newDistrictName').value.trim();
                const country = document.getElementById('newDistrictCountry').value;
                
                let districts = getDistrictData();
                if (districts.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                    showAlert('districtAlert', 'error', 'District name already exists.');
                    return;
                }
                
                const newId = `D${String(districts.length + 1).padStart(3, '0')}`;
                districts.push({ id: newId, name, country });
                saveDistrictData(districts);
                showAlert('districtAlert', 'success', `District ${name} added successfully.`);
                renderDistrictsTable();
                populateDistrictDropdowns();
                document.getElementById('newDistrictName').value = '';
            });

            document.getElementById('districtsTableBody').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-district-btn');
                if (deleteBtn) {
                    const districtName = deleteBtn.dataset.name; // Get name, not id
                    if (confirm(`Are you sure you want to delete the district "${districtName}"? All associated data must be unassigned first.`)) {
                        let districts = getDistrictData().filter(d => d.name !== districtName);
                        saveDistrictData(districts);
                        showAlert('districtAlert', 'success', `District "${districtName}" deleted.`);
                        renderDistrictsTable();
                        populateDistrictDropdowns();
                    }
                }
            });

            // --- PROFILE/PASSWORD LOGIC ---
            document.getElementById('adminPasswordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                const user = getLoggedInUser();
                
                if (!user) {
                     showAlert('adminAlert', 'error', 'Error: Not logged in.');
                     return;
                }
                
                // Find the user's details in the correct admin list
                let admins = getAdminData();
                const index = admins.findIndex(a => a.username === user.username);
                
                if (index === -1) {
                    showAlert('adminAlert', 'error', 'Error: Could not find user account.');
                    return;
                }
                
                const userAccount = admins[index];

                if (currentPassword !== userAccount.password) {
                    showAlert('adminAlert', 'error', 'Current password is incorrect.');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showAlert('adminAlert', 'error', 'New passwords do not match.');
                    return;
                }
                
                admins[index].password = newPassword;
                saveAdminData(admins);
                
                // Update session storage as well
                const updatedUser = {...user, password: newPassword};
                sessionStorage.setItem(LOGGED_IN_USER_KEY, JSON.stringify(updatedUser));
                
                showAlert('adminAlert', 'success', 'Password updated successfully!');
                document.getElementById('adminPasswordForm').reset();
            });

            // --- SYSTEM RESET LOGIC ---
            document.getElementById('resetDataBtn').addEventListener('click', () => {
                if (confirm('WARNING: This will delete ALL application data (inventory, users, districts, logs). Are you absolutely sure?')) {
                    localStorage.clear();
                    sessionStorage.clear();
                    // Re-initialize sample data and redirect to login
                    initializeData();
                    alert('Application data reset complete. Redirecting to login.');
                    window.location.href = 'login.html';
                }
            });

            // --- GENERAL SETUP ---
            function initializeApp() {
                initializeData();
                setupUserUI();
                populateDistrictDropdowns();

                // Render all tables
                renderSupervisorsTable();
                renderFieldOfficersTable();
                renderVennOfficersTable(); // NEW
                renderDataCollectorsTable();
                renderAdminsTable();
                renderDistrictsTable();

                // Setup all event listeners
                setupSupervisorEventListeners();
                setupFieldOfficerEventListeners();
                setupVennOfficerEventListeners(); // NEW
                setupDataCollectorEventListeners();
                setupAdminEventListeners();

                // General event listeners
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modalId = e.currentTarget.dataset.modal || e.currentTarget.closest('.modal').id;
                        document.getElementById(modalId).style.display = 'none';
                    });
                });
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', togglePasswordVisibility);
                });
                document.getElementById('logout-btn').addEventListener('click', () => {
                    sessionStorage.removeItem(LOGGED_IN_USER_KEY);
                    window.location.href = 'login.html';
                });
                
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
                        
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab + 'Tab').classList.add('active');
                    });
                });
                
                // --- UPDATED: Add listeners for new bulk upload buttons ---
                document.getElementById('bulkUploadSupervisorBtn').addEventListener('click', () => openBulkUploadModal('supervisor'));
                document.getElementById('bulkUploadFieldOfficerBtn').addEventListener('click', () => openBulkUploadModal('fieldOfficer'));
                document.getElementById('bulkUploadVennOfficerBtn').addEventListener('click', () => openBulkUploadModal('vennOfficer'));
                document.getElementById('bulkUploadCollectorBtn').addEventListener('click', () => openBulkUploadModal('dataCollector'));

                
                // Listen for changes in other tabs to refresh the table
                window.addEventListener('storage', (e) => {
                    if (e.key === SUPERVISOR_KEY) renderSupervisorsTable();
                    if (e.key === FIELD_OFFICER_KEY) renderFieldOfficersTable();
                    if (e.key === VENN_OFFICER_KEY) renderVennOfficersTable(); // NEW
                    if (e.key === DATA_COLLECTOR_KEY) renderDataCollectorsTable();
                    if (e.key === ADMIN_KEY) renderAdminsTable();
                    if (e.key === DISTRICT_KEY) {
                        populateDistrictDropdowns();
                        renderDistrictsTable();
                        renderSupervisorsTable(); // Rerender users to reflect new district names
                        renderFieldOfficersTable();
                        renderVennOfficersTable(); // NEW
                        renderDataCollectorsTable();
                    }
                });
            }
            
            initializeApp();
        });
    </script>
</body>
</html>
