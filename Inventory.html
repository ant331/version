<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV Inventory Hub | Inventory Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .card-body {
            padding: 1.5rem;
        }

        /* Stat Card */
        .stat-card .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-value.small {
            font-size: 2rem;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .stat-sublabel {
            font-size: 0.85rem;
            color: var(--success);
            font-weight: 500;
            margin-top: -0.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #0da271;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #cc3333;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background: var(--light);
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .inventory-table thead th {
            text-align: left;
            padding: 1.25rem;
            background: var(--light);
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--border);
            vertical-align: top;
        }
        
        .inventory-table thead th input[type="checkbox"] {
            cursor: pointer;
        }
        
        .inventory-table thead th select {
            padding: 0.25rem; 
            font-size: 0.8rem; 
            margin-top: 4px; 
            min-width: 100px;
        }

        .inventory-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }
        
        .inventory-table tbody tr.selected {
            background-color: #fee2e2;
        }

        .inventory-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .inventory-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .inventory-table td {
            padding: 1rem 1.25rem;
            vertical-align: middle;
            font-size: 0.9rem;
            color: #475569;
        }
        
        .inventory-table tbody td input[type="checkbox"] {
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        
        .status-available { color: #065f46; background-color: #d1fae5; }
        .status-in-use { color: #1e40af; background-color: #dbeafe; }
        .status-maintenance { color: #92400e; background-color: #fef3c7; }
        .status-retired { color: #991b1b; background-color: #fee2e2; }
        .status-pending-transfer { color: #9a3412; background-color: #ffedd5; } /* Added missing status */
        .status-reported-missing { color: #7f1d1d; background-color: #fee2e2; } /* Added missing status */

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-buttons .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        
        .modal-content h3 {
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-footer {
            margin-top: 1.5rem;
            text-align: right;
        }
        
        #search-box {
            width: 300px;
        }

        #qr-code-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            font-size: 0.9rem;
        }
        
        .notification.show {
            opacity: 1;
            visibility: visible;
        }
        
        #upload-preview {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        #upload-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        #upload-preview th, #upload-preview td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>
<body>
    <script>
        // Security Check: This script runs first to protect the page.
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            // If no user is logged in, redirect to the login page.
            window.location.href = 'login.html';
        } else if (loggedInUser.role !== 'admin') {
            // If a user is logged in but is NOT an admin, redirect them to their default page.
            window.location.href = 'supervisor.html';
        }
    </script>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="RTV Inventory Hub Logo" class="sidebar-logo">
                <h2>RTV Inventory Hub</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
                <a href="Inventory.html" class="menu-item active">
                    <i class="fas fa-list"></i>
                    <span class="menu-text">Inventory</span>
                </a>
                <a href="supervisor.html" class="menu-item">
                    <i class="fas fa-user-shield"></i>
                    <span class="menu-text">Supervisor</span>
                </a>
                <a href="field_office.html" class="menu-item">
                    <i class="fas fa-warehouse"></i>
                    <span class="menu-text">Field Office</span>
                </a>
                <a href="venn_officer.html" class="menu-item">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Venn Officer</span>
                </a>
                <a href="transfers.html" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="menu-text">Transfers</span>
                </a>
                <a href="reports.html" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Reports</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Inventory Management</h1>
                    <p>Manage and track all inventory items</p>
                </div>
                <div class="header-actions">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" id="new-item-btn"><i class="fas fa-plus"></i> New Item</button>
                        <button class="btn btn-outline" id="bulk-upload-btn"><i class="fas fa-upload"></i> Bulk Upload</button>
                    </div>
                     <button class="btn btn-danger" id="bulk-delete-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Bulk Delete</button>
                    <input type="text" id="search-box" class="form-control" placeholder="Search by ID, name, or type...">
                    <button class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>
            
            <div class="dashboard-grid">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-value" id="total-items">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-value" id="available-items">0</div>
                        <div class="stat-label">Available</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-value" id="in-use-items">0</div>
                        <div class="stat-label">In Use</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-value" id="maintenance-items">0</div>
                        <div class="stat-label">Maintenance</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="stat-value" id="retired-items">0</div>
                        <div class="stat-label">Retired</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card stat-card">
                    <div class="card-body">
                        <i class="fas fa-tablet-alt stat-icon"></i>
                        <div class="stat-value small" id="tablet-total">0</div>
                        <div class="stat-label">Tablets</div>
                        <div class="stat-sublabel"><span id="tablet-available">0</span> Available</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <i class="fas fa-mobile-alt stat-icon"></i>
                        <div class="stat-value small" id="phone-total">0</div>
                        <div class="stat-label">Phones</div>
                        <div class="stat-sublabel"><span id="phone-available">0</span> Available</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <i class="fas fa-charging-station stat-icon"></i>
                        <div class="stat-value small" id="charger-total">0</div>
                        <div class="stat-label">Chargers</div>
                        <div class="stat-sublabel"><span id="charger-available">0</span> Available</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <i class="fas fa-briefcase stat-icon"></i>
                        <div class="stat-value small" id="bag-total">0</div>
                        <div class="stat-label">Bags</div>
                        <div class="stat-sublabel"><span id="bag-available">0</span> Available</div>
                    </div>
                </div>
                <div class="card stat-card">
                    <div class="card-body">
                        <i class="fas fa-car-battery stat-icon"></i>
                        <div class="stat-value small" id="power-bank-total">0</div>
                        <div class="stat-label">Power Banks</div>
                        <div class="stat-sublabel"><span id="power-bank-available">0</span> Available</div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox"></th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>
                                <div>Type</div>
                                <select id="filter-type" class="form-control"><option value="">All Types</option></select>
                            </th>
                            <th>
                                <div>Status</div>
                                <select id="filter-status" class="form-control"><option value="">All Statuses</option></select>
                            </th>
                            <th>Assigned To</th>
                            <th>
                                <div>District</div>
                                <select id="filter-district" class="form-control"><option value="">All Districts</option></select>
                            </th>
                            <th>Last Update</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                        </tbody>
                </table>
            </div>
            
        </main>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 id="modal-title">Add New Item</h3>
            <form id="item-form">
                <input type="hidden" id="item-id-hidden">
                <div class="form-group">
                    <label for="item-id">Item ID *</label>
                    <input type="text" class="form-control" id="item-id" placeholder="Enter ID or leave blank for auto-generate" required>
                    <small style="color: var(--secondary);">Note: Auto-generate requires leaving this field blank.</small>
                </div>
                <div class="form-group">
                    <label for="item-name">Item Name *</label>
                    <input type="text" class="form-control" id="item-name" required>
                </div>
                <div class="form-group">
                    <label for="item-type">Item Type *</label>
                    <select class="form-control" id="item-type" required>
                        <option value="">Select a type</option>
                        <option value="tablet">Tablet</option>
                        <option value="phone">Phone</option>
                        <option value="charger">Charger</option>
                        <option value="bag">Bag</option>
                        <option value="power-bank">Power Bank</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-assigned">Assigned To (Supervisor)</label>
                    <select class="form-control" id="item-assigned">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-district">District *</label>
                    <select class="form-control" id="item-district" required>
                        <option value="">Select a District</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-status">Status *</label>
                    <select class="form-control" id="item-status" required>
                        <option value="available">Available</option>
                        <option value="in-use">In Use</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="retired">Retired</option>
                        <option value="pending-transfer">Pending Transfer</option>
                        <option value="reported-missing">Reported Missing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-notes">Notes</label>
                    <textarea class="form-control" id="item-notes" rows="3" placeholder="Add any relevant notes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-item-btn">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulk-upload-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>Bulk Upload</h3>
            <p>Upload a CSV or XLSX file to add multiple items. Required columns are 'name', 'type', and 'district'.</p>
            <div class="form-group">
                <label for="file-upload">Choose File</label>
                <input type="file" class="form-control" id="file-upload" accept=".csv, .xlsx, .xls">
            </div>
            <div id="upload-preview" style="display: none;">
                <h4>Preview (First 5 Rows)</h4>
                <table id="preview-table"></table>
            </div>
            <div class="modal-footer">
                <a href="data:text/csv;charset=utf-8,id,name,type,status,assigned,district,notes%0ATBL-DEMO-1,Sample Tablet,tablet,available,,mbarara,This is a sample row" download="inventory_template.csv" class="btn btn-outline" id="download-template-btn">
                    <i class="fas fa-download"></i> Download Template
                </a>
                <button type="button" class="btn btn-success" id="confirm-upload" disabled>
                    <i class="fas fa-check"></i> Process Upload
                </button>
            </div>
        </div>
    </div>
    
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>QR Code for <span id="qr-item-name"></span></h3>
            <div id="qr-code-display">
                <canvas id="qr-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <div id="notification-toast" class="notification"></div>
    
    <script>
        let inventory = [];
        let movementLogs = [];
        let selectedItems = new Set();
        
        // --- CONSTANTS & DOM ELEMENTS ---
        const itemTypes = ['tablet', 'phone', 'charger', 'bag', 'power-bank', 'other'];

        const inventoryTableBody = document.getElementById('inventory-table-body');
        const searchBox = document.getElementById('search-box');
        const filterTypeSelect = document.getElementById('filter-type');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterDistrictSelect = document.getElementById('filter-district');

        // Modals
        const itemModal = document.getElementById('item-modal');
        const bulkUploadModal = document.getElementById('bulk-upload-modal');
        const qrModal = document.getElementById('qr-modal');

        // Forms and Inputs (Item Modal)
        const itemForm = document.getElementById('item-form');
        const itemIdHidden = document.getElementById('item-id-hidden');
        const itemIdInput = document.getElementById('item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemTypeSelect = document.getElementById('item-type');
        const itemStatusSelect = document.getElementById('item-status');
        const itemAssignedSelect = document.getElementById('item-assigned');
        const itemDistrictSelect = document.getElementById('item-district');
        const itemNotesInput = document.getElementById('item-notes');

        // Bulk Upload Modal
        const fileUploadInput = document.getElementById('file-upload');
        const uploadPreviewDiv = document.getElementById('upload-preview');
        const previewTable = document.getElementById('preview-table');
        const confirmUploadBtn = document.getElementById('confirm-upload');

        // Other elements
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        // --- CORE DATA FUNCTIONS ---
        function getInventoryData() { return JSON.parse(localStorage.getItem('inventoryData')) || []; }
        function getMovementLogs() { return JSON.parse(localStorage.getItem('movementLogs')) || []; }
        function getSupervisorData() { return JSON.parse(localStorage.getItem('supervisors')) || []; }
        function getDistrictData() { return JSON.parse(localStorage.getItem('districts')) || []; }
        
        function saveData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
            localStorage.setItem('movementLogs', JSON.stringify(movementLogs));
            // Trigger storage event so other tabs/windows update
            window.dispatchEvent(new Event('storage'));
        }

        function generateId(type) {
            let prefix = (type || 'GEN').substring(0, 3).toUpperCase();
            const randomDigits = Math.floor(1000 + Math.random() * 9000); // 4 random digits
            const randomNumber = Math.floor(Math.random() * 100); // For better uniqueness
            return `${prefix}-${randomDigits}-${randomNumber}`;
        }

        function logMovement(itemId, action, details) {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser')) || { username: 'System', role: 'system' };
            movementLogs.unshift({
                itemId,
                action,
                details,
                timestamp: new Date().toISOString(),
                user: user.username,
                role: user.role
            });
        }

        function applyBusinessRules(item) {
            // Rule: If an item's district is 'mbarara' (central store), it cannot be 'in-use' or assigned.
            if (item.district && item.district.toLowerCase() === 'mbarara') {
                if (item.status === 'in-use' || item.assigned !== '') {
                    logMovement(item.id, 'status_update', `Status auto-updated from '${item.status}' to 'available' as it is in the Mbarara central store and cannot be 'in-use' or assigned there.`);
                    item.status = 'available';
                    item.assigned = ''; // Available items in central store should not be assigned
                    item.lastUpdate = new Date().toLocaleDateString();
                }
            }
            return item;
        }

        function loadData() {
            try {
                inventory = getInventoryData();
                movementLogs = getMovementLogs();
                let wasModified = false;

                // Apply rules on load
                inventory.forEach((item, index) => {
                    const originalStatus = item.status;
                    const originalAssigned = item.assigned;
                    const updatedItem = applyBusinessRules(item);
                    if (updatedItem.status !== originalStatus || updatedItem.assigned !== originalAssigned) {
                        wasModified = true;
                    }
                    inventory[index] = updatedItem;
                });

                if (wasModified) {
                    saveData();
                }
            } catch (e) {
                console.error("Failed to parse data from localStorage.", e);
                inventory = [];
                movementLogs = [];
            }
        }

        function initializeData() {
            // Seed sample inventory if missing (only happens on first run)
            if (!localStorage.getItem('inventoryData')) {
                const today = new Date().toLocaleDateString();
                const sampleInventory = [
                    { id: 'TBL-0421', name: 'iPad Pro 12.9"', type: 'tablet', status: 'available', assigned: '', district: 'mbarara', lastUpdate: today, notes: '' },
                    { id: 'PHN-1872', name: 'Samsung Galaxy S21', type: 'phone', status: 'in-use', assigned: 'John Smith', district: 'Kagadi', lastUpdate: today, notes: '' },
                    { id: 'CHG-9901', name: 'Anker PowerCore', type: 'charger', status: 'pending-transfer', assigned: '', district: 'mbarara', lastUpdate: today, notes: 'Returned from Kyenjojo' },
                    { id: 'BAG-1002', name: 'RTV Backpack', type: 'bag', status: 'maintenance', assigned: '', district: 'mbarara', lastUpdate: today, notes: 'Broken zip' },
                    { id: 'POW-0055', name: 'Large Power Bank', type: 'power-bank', status: 'retired', assigned: '', district: 'Kyotera', lastUpdate: today, notes: 'End of life' }
                ];
                localStorage.setItem('inventoryData', JSON.stringify(sampleInventory));
            }
        }
        
        function populateDropdowns() {
            const supervisors = getSupervisorData();
            const districtsData = getDistrictData();

            // 1. Populate Assigned To dropdown (item-assigned)
            itemAssignedSelect.innerHTML = '<option value="">Unassigned</option>';
            supervisors.sort((a, b) => a.username.localeCompare(b.username)).forEach(user => {
                const option = new Option(user.username, user.username);
                itemAssignedSelect.add(option);
            });

            // 2. Populate District dropdown (item-district) - Handles both string[] and object[] formats
            itemDistrictSelect.innerHTML = '<option value="">Select a District</option>';
            let districtNames = [];
            if (districtsData.length > 0) {
                if (typeof districtsData[0] === 'string') {
                    districtNames = districtsData.sort();
                } else if (typeof districtsData[0] === 'object' && districtsData[0].name) {
                    districtNames = districtsData.map(d => d.name).sort();
                }
            }
            districtNames.forEach(name => {
                const option = new Option(name, name.toLowerCase());
                itemDistrictSelect.add(option);
            });
        }
        
        function updateStats() {
            const total = inventory.length;
            const available = inventory.filter(i => i.status === 'available').length;
            const inUse = inventory.filter(i => i.status === 'in-use').length;
            const maintenance = inventory.filter(i => i.status === 'maintenance').length;
            const retired = inventory.filter(i => i.status === 'retired').length;

            document.getElementById('total-items').textContent = total;
            document.getElementById('available-items').textContent = available;
            document.getElementById('in-use-items').textContent = inUse;
            document.getElementById('maintenance-items').textContent = maintenance;
            document.getElementById('retired-items').textContent = retired;
        }
        
        /**
         * @BuggFix: Updated the logic to standardize the item type key before checking.
         * This handles inconsistencies from bulk uploads (e.g., 'Power Banks' vs 'power-bank').
         */
        function updateTypeStats() {
            const typeCounts = {
                'tablet': { total: 0, available: 0 },
                'phone': { total: 0, available: 0 },
                'charger': { total: 0, available: 0 },
                'bag': { total: 0, available: 0 },
                'power-bank': { total: 0, available: 0 },
            };

            inventory.forEach(item => {
                // BUG FIX: Standardize the item type by converting to lowercase and replacing spaces/underscores with hyphens
                // This ensures 'Power Banks' -> 'power-banks' -> 'power-bank' (handled by the dictionary check)
                const standardizedType = item.type.toLowerCase().replace(/ /g, '-').replace(/s$/, ''); // Remove trailing 's' to match singular key

                if (typeCounts[standardizedType]) {
                    typeCounts[standardizedType].total++;
                    if (item.status === 'available') {
                        typeCounts[standardizedType].available++;
                    }
                }
            });

            for (const type in typeCounts) {
                document.getElementById(`${type}-total`).textContent = typeCounts[type].total;
                document.getElementById(`${type}-available`).textContent = typeCounts[type].available;
            }
        }
        
        function populateTableFilters() {
            const allTypes = [...new Set(inventory.map(i => i.type.toLowerCase()))].sort();
            const allStatuses = [...new Set(inventory.map(i => i.status))].sort();
            const allDistricts = [...new Set(inventory.map(i => i.district))].filter(d => d).sort();

            function populateSelect(selectElement, options) {
                const currentVal = selectElement.value;
                selectElement.innerHTML = '<option value="">All</option>';
                options.forEach(option => {
                    const display = option.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    const opt = new Option(display, option);
                    if (option === currentVal) opt.selected = true;
                    selectElement.add(opt);
                });
            }

            // Filter for only types that are in the itemTypes array, ensuring 'other' and standard types show up
            const filterableTypes = itemTypes.filter(t => allTypes.includes(t) || itemTypes.includes(t));
            
            if (filterTypeSelect) populateSelect(filterTypeSelect, filterableTypes);
            if (filterStatusSelect) populateSelect(filterStatusSelect, allStatuses);
            if (filterDistrictSelect) populateSelect(filterDistrictSelect, allDistricts);
        }

        function renderTable(filteredData) {
            inventoryTableBody.innerHTML = '';
            if (filteredData.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No items found matching the current criteria.</td></tr>';
                return;
            }

            filteredData.forEach(item => {
                const isSelected = selectedItems.has(item.id);
                const row = document.createElement('tr');
                row.className = isSelected ? 'selected' : '';
                
                const statusClass = `status-${item.status.toLowerCase().replace(/ /g, '-')}`;
                const displayStatus = item.status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                row.innerHTML = `
                    <td><input type="checkbox" class="item-checkbox" data-item-id="${item.id}" ${isSelected ? 'checked' : ''}></td>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
                    <td><span class="status-badge ${statusClass}">${displayStatus}</span></td>
                    <td>${item.assigned || 'N/A'}</td>
                    <td style="text-transform: capitalize;">${item.district || 'N/A'}</td>
                    <td>${item.lastUpdate}</td>
                    <td class="action-buttons">
                        <button class="btn btn-outline" onclick="handleEditItem('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-outline" onclick="handleQrCode('${item.id}', '${item.name}')" title="QR Code"><i class="fas fa-qrcode"></i></button>
                        <button class="btn btn-danger" onclick="handleDelete('${item.id}')" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });
        }
        
        function filterInventory() {
            const searchTerm = searchBox.value.toLowerCase();
            const filterType = filterTypeSelect.value.toLowerCase();
            const filterStatus = filterStatusSelect.value.toLowerCase();
            const filterDistrict = filterDistrictSelect.value.toLowerCase();

            const filtered = inventory.filter(item => {
                const matchesSearch = !searchTerm || 
                                      item.id.toLowerCase().includes(searchTerm) ||
                                      item.name.toLowerCase().includes(searchTerm) ||
                                      item.type.toLowerCase().includes(searchTerm);
                                      
                const matchesType = !filterType || item.type.toLowerCase() === filterType;
                const matchesStatus = !filterStatus || item.status.toLowerCase() === filterStatus;
                const matchesDistrict = !filterDistrict || (item.district && item.district.toLowerCase() === filterDistrict);
                                      
                return matchesSearch && matchesType && matchesStatus && matchesDistrict;
            });

            renderTable(filtered);
            updateBulkDeleteButton();
        }

        // --- MODAL / FORM HANDLERS ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function resetItemForm() {
            itemForm.reset();
            itemIdHidden.value = '';
            itemIdInput.value = '';
            itemIdInput.disabled = false;
            document.getElementById('modal-title').textContent = 'Add New Item';
        }

        function handleNewItem() {
            resetItemForm();
            // Automatically select 'mbarara' and 'available' for new items if they exist
            itemDistrictSelect.value = 'mbarara';
            itemStatusSelect.value = 'available';
            openModal('item-modal');
        }

        function handleItemFormSubmit(e) {
            e.preventDefault();
            
            let item = {};
            const isEditing = itemIdHidden.value !== '';
            let finalItemId = itemIdInput.value.trim().toUpperCase();

            // 1. New Item ID generation/validation
            if (!isEditing) {
                if (finalItemId === '') {
                    finalItemId = generateId(itemTypeSelect.value);
                }
                if (inventory.some(i => i.id === finalItemId)) {
                    showNotification('Error: Item ID is already in use.', 'danger');
                    return;
                }
                item.id = finalItemId;
                item.lastUpdate = new Date().toLocaleDateString();
            } else {
                item = inventory.find(i => i.id === itemIdHidden.value);
                if (!item) {
                    showNotification('Error: Item not found.', 'danger');
                    return;
                }
            }

            // 2. Collect form data
            item.name = itemNameInput.value.trim();
            item.type = itemTypeSelect.value;
            item.status = itemStatusSelect.value;
            item.assigned = itemAssignedSelect.value;
            item.district = itemDistrictSelect.value;
            item.notes = itemNotesInput.value.trim();
            
            // 3. Apply business rules (e.g., central store)
            item = applyBusinessRules(item);

            // 4. Save to inventory
            if (!isEditing) {
                inventory.push(item);
                logMovement(item.id, 'creation', `New item added. Name: ${item.name}. District: ${item.district}.`);
                showNotification(`Item ${item.id} added successfully.`);
            } else {
                const itemIndex = inventory.findIndex(i => i.id === itemIdHidden.value);
                if(itemIndex > -1) {
                    inventory[itemIndex] = item;
                }
                logMovement(item.id, 'update', `Item updated. New status: ${item.status}. Assigned to: ${item.assigned || 'N/A'}.`);
                showNotification(`Item ${item.id} updated successfully.`);
            }

            saveData();
            updateAllViews();
            closeModal('item-modal');
        }

        function handleEditItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return showNotification('Item not found!', 'danger');

            document.getElementById('modal-title').textContent = `Edit Item: ${itemId}`;
            
            // Populate form fields
            itemIdHidden.value = item.id;
            itemIdInput.value = item.id;
            itemIdInput.disabled = true; // Prevent ID modification on edit
            itemNameInput.value = item.name;
            itemTypeSelect.value = item.type;
            itemStatusSelect.value = item.status;
            itemAssignedSelect.value = item.assigned;
            itemDistrictSelect.value = item.district;
            itemNotesInput.value = item.notes;

            openModal('item-modal');
        }

        function handleDelete(itemId) {
            if (confirm(`Are you sure you want to permanently delete item ${itemId}? This action cannot be undone.`)) {
                inventory = inventory.filter(item => item.id !== itemId);
                logMovement(itemId, 'deletion', `Item permanently deleted.`);
                showNotification(`Item ${itemId} deleted.`, 'danger');
                saveData();
                updateAllViews();
            }
        }
        
        function handleBulkDelete() {
            if (selectedItems.size === 0) {
                showNotification('No items selected for bulk deletion.', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to permanently delete ${selectedItems.size} selected item(s)? This action cannot be undone.`)) {
                const deletedIds = [];
                inventory = inventory.filter(item => {
                    const keep = !selectedItems.has(item.id);
                    if (!keep) {
                        deletedIds.push(item.id);
                        logMovement(item.id, 'bulk_deletion', `Item bulk deleted.`);
                    }
                    return keep;
                });
                
                selectedItems.clear();
                showNotification(`${deletedIds.length} item(s) permanently deleted.`, 'danger');
                saveData();
                updateAllViews();
            }
        }
        
        function updateBulkDeleteButton() {
            if (selectedItems.size > 0) {
                bulkDeleteBtn.style.display = 'inline-flex';
                bulkDeleteBtn.textContent = `Bulk Delete (${selectedItems.size})`;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
        }

        function handleQrCode(itemId, itemName) {
            document.getElementById('qr-item-name').textContent = itemName;
            // The QR code stores a simple string that can be scanned for quick lookup
            generateQrCode(`RTV_INVENTORY_ITEM:${itemId}`); 
            openModal('qr-modal');
        }

        function generateQrCode(text) {
             QRCode.toCanvas(document.getElementById('qr-canvas'), text, { width: 200, color: { dark: '#1e293b' } }, (error) => {
                if (error) console.error(error);
            });
        }
        
        // --- BULK UPLOAD HANDLERS ---
        function openBulkUploadModal() {
            fileUploadInput.value = ''; // Reset input
            uploadPreviewDiv.style.display = 'none';
            confirmUploadBtn.disabled = true;
            openModal('bulk-upload-modal');
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) {
                uploadPreviewDiv.style.display = 'none';
                confirmUploadBtn.disabled = true;
                return;
            }

            if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true, // Important for cleaning up CSVs
                    transformHeader: (header) => header.toLowerCase().trim().replace(/[^a-z0-9]+/g, '_'), // Normalize headers
                    complete: (results) => parseFile(results.data, results.errors)
                });
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    // Convert to array of objects, then to CSV string for consistent parsing
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});
                    const csv = Papa.unparse(json);
                    
                    Papa.parse(csv, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.toLowerCase().trim().replace(/[^a-z0-9]+/g, '_'),
                        complete: (results) => parseFile(results.data, results.errors)
                    });
                };
                reader.readAsArrayBuffer(file);
            } else {
                showNotification('Unsupported file type.', 'danger');
            }
        }
        
        function parseFile(data, errors) {
            if (errors.length > 0) {
                 // Basic error handling for CSV parsing issues
                console.error('File parsing errors:', errors);
            }
            
            // Check for required headers after normalization. Note: 'type' might be 'type' or 'item_type' etc.
            const requiredFields = ['name', 'type', 'district'];
            const firstRowKeys = Object.keys(data[0] || {});
            
            const hasRequiredFields = requiredFields.every(field => firstRowKeys.includes(field));
            
            if (!hasRequiredFields) {
                showNotification(`Missing required column headers in file. Needed: ${requiredFields.join(', ')}. Found: ${firstRowKeys.join(', ')}`, 'danger');
                confirmUploadBtn.disabled = true;
                uploadPreviewDiv.style.display = 'none';
                return;
            }

            const cleanData = data.filter(row => row.name && row.type && row.district);

            if (cleanData.length === 0) {
                showNotification('No valid data found in the file. Check for missing "name", "type", or "district" fields.', 'warning');
                confirmUploadBtn.disabled = true;
                uploadPreviewDiv.style.display = 'none';
                return;
            }

            // Store clean data temporarily for bulk processing
            confirmUploadBtn.dataset.uploadData = JSON.stringify(cleanData);
            confirmUploadBtn.disabled = false;
            
            // Render preview
            previewTable.innerHTML = '';
            const headerRow = document.createElement('tr');
            ['ID', 'Name', 'Type', 'Status', 'District'].forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            previewTable.appendChild(headerRow);

            cleanData.slice(0, 5).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id || 'AUTO'}</td>
                    <td>${row.name || 'N/A'}</td>
                    <td>${row.type || 'N/A'}</td>
                    <td>${row.status || 'available'}</td>
                    <td>${row.district || 'N/A'}</td>
                `;
                previewTable.appendChild(tr);
            });
            uploadPreviewDiv.style.display = 'block';
            showNotification(`Previewing ${cleanData.length} valid item(s) for upload.`, 'success');
        }

        function handleBulkUploadConfirm() {
            const dataString = confirmUploadBtn.dataset.uploadData;
            if (!dataString) return;
            
            const uploadedData = JSON.parse(dataString);
            const today = new Date().toLocaleDateString();
            let successCount = 0;

            uploadedData.forEach(row => {
                let itemId = (row.id && row.id.trim().toUpperCase()) || generateId(row.type);

                // Ensure unique ID
                while (inventory.some(i => i.id === itemId)) {
                    itemId = generateId(row.type); 
                }

                const newItem = {
                    id: itemId,
                    name: (row.name || 'Unknown').trim(),
                    type: (row.type || 'other').toLowerCase().trim(),
                    status: (row.status || 'available').toLowerCase().trim().replace(/ /g, '-'), // Normalize status
                    assigned: (row.assigned || '').trim(),
                    district: (row.district || '').toLowerCase().trim(),
                    lastUpdate: today,
                    notes: (row.notes || '').trim()
                };
                
                // Apply rules and save
                inventory.push(applyBusinessRules(newItem));
                logMovement(newItem.id, 'bulk_upload', `Item added via bulk upload. Type: ${newItem.type}.`);
                successCount++;
            });

            saveData();
            showNotification(`Successfully uploaded and added ${successCount} item(s).`);
            closeModal('bulk-upload-modal');
            updateAllViews();
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Modal close listeners (for 'x' and cancel buttons)
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if(modal) closeModal(modal.id);
                });
            });

            // Main buttons
            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            });
            document.getElementById('new-item-btn').addEventListener('click', handleNewItem);
            document.getElementById('bulk-upload-btn').addEventListener('click', openBulkUploadModal);
            bulkDeleteBtn.addEventListener('click', handleBulkDelete);

            // Form Submissions
            itemForm.addEventListener('submit', handleItemFormSubmit);
            
            // Search and Filters
            searchBox.addEventListener('input', filterInventory);
            filterTypeSelect.addEventListener('change', filterInventory);
            filterStatusSelect.addEventListener('change', filterInventory);
            filterDistrictSelect.addEventListener('change', filterInventory);

            // Checkbox handlers
            selectAllCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const itemId = checkbox.dataset.itemId;
                    if (isChecked) {
                        selectedItems.add(itemId);
                        checkbox.closest('tr').classList.add('selected');
                    } else {
                        selectedItems.delete(itemId);
                        checkbox.closest('tr').classList.remove('selected');
                    }
                });
                updateBulkDeleteButton();
            });
            inventoryTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('item-checkbox')) {
                    const itemId = e.target.dataset.itemId;
                    if (e.target.checked) {
                        selectedItems.add(itemId);
                        e.target.closest('tr').classList.add('selected');
                    } else {
                        selectedItems.delete(itemId);
                        e.target.closest('tr').classList.remove('selected');
                    }
                    // If one is unchecked, uncheck select-all
                    if (!e.target.checked) selectAllCheckbox.checked = false;
                    updateBulkDeleteButton();
                }
            });

            // Bulk Upload Listeners
            fileUploadInput.addEventListener('change', handleFileSelect);
            confirmUploadBtn.addEventListener('click', handleBulkUploadConfirm);
        }

        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.className = `notification show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateAllViews() {
            populateTableFilters(); // Re-populate filters
            filterInventory(); // Then filter the view
            updateStats();
            updateTypeStats();
            updateBulkDeleteButton();
        }

        function initApp() {
            initializeData(); // Ensure sample inventory is available
            loadData(); // Load all data
            populateDropdowns(); // Populate modal dropdowns
            setupEventListeners();
            updateAllViews();
        }

        window.addEventListener('storage', (e) => {
            // Listen for changes in other tabs/windows
            if (e.key === 'inventoryData' || e.key === 'districts' || e.key === 'supervisors') {
                loadData();
                populateDropdowns();
                updateAllViews();
            }
        });

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>
