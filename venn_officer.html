<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV Inventory Hub | Venn Officer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-body {
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--secondary);
            font-weight: 500;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .inventory-table thead th {
            text-align: left;
            padding: 1.25rem;
            background: var(--light);
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--border);
        }
        
        .inventory-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }

        .inventory-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .inventory-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .inventory-table td {
            padding: 1rem 1.25rem;
            vertical-align: middle;
            font-size: 0.9rem;
            color: #475569;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        
        .status-available { color: #065f46; background-color: #d1fae5; }
        .status-in-use { color: #1e40af; background-color: #dbeafe; }
        .status-maintenance { color: #92400e; background-color: #fef3c7; }
        .status-retired { color: #991b1b; background-color: #fee2e2; }
        .status-pending-transfer { color: #9a3412; background-color: #ffedd5; }
        .status-in-storage-field { color: #5b21b6; background-color: #ede9fe; }
        .status-reported-missing { color: #b91c1c; background-color: #fee2e2; }


        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0da271; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c53030; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--secondary); }
        .btn-outline:hover { background: var(--light); }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .modal-content h3 { margin-bottom: 1.5rem; color: var(--dark); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 1rem; right: 1.5rem; }
        .modal-close:hover, .modal-close:focus { color: #000; text-decoration: none; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        .modal-footer { margin-top: 1.5rem; text-align: right; }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            font-size: 0.9rem;
        }
        
        .notification.show { opacity: 1; visibility: visible; }
        
        /* Officer Selector (Admin only) */
        .officer-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .officer-selector label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .officer-selector select {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: white;
        }
    </style>
</head>
<body>
    <script>
        // --- UPDATED SECURITY CHECK ---
        // This page is only for 'venn_officer' and 'admin' roles.
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            // No user, redirect to login
            window.location.href = 'login.html';
        } else if (loggedInUser.role !== 'admin' && loggedInUser.role !== 'venn_officer') {
            // User is logged in, but is NOT an admin or a venn_officer.
            // Redirect them to their appropriate dashboard.
            if (loggedInUser.role === 'supervisor') {
                 window.location.href = 'supervisor.html';
            } else if (loggedInUser.role === 'field_officer') {
                 window.location.href = 'field_office.html';
            } else {
                // Fallback for any other unknown role
                 window.location.href = 'login.html';
            }
        }
        // If we are here, the user is either 'admin' or 'venn_officer' and is allowed.
    </script>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="RTV Inventory Hub Logo" class="sidebar-logo">
                <h2>RTV Inventory Hub</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
                <a href="Inventory.html" class="menu-item">
                    <i class="fas fa-list"></i>
                    <span class="menu-text">Inventory</span>
                </a>
                <a href="supervisor.html" class="menu-item">
                    <i class="fas fa-user-shield"></i>
                    <span class="menu-text">Supervisor</span>
                </a>
                <a href="field_office.html" class="menu-item">
                    <i class="fas fa-warehouse"></i>
                    <span class="menu-text">Field Office</span>
                </a>
                <a href="venn_officer.html" class="menu-item active">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Venn Officer</span>
                </a>
                <a href="transfers.html" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="menu-text">Transfers</span>
                </a>
                <a href="reports.html" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Reports</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Venn Officer Dashboard (<span id="district-name">District</span>)</h1>
                    <p>Manage equipment for your assigned activities</p>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <div class="avatar" id="user-avatar">V</div>
                        <div>
                            <div id="user-name">User</div>
                            <small id="user-role">Role</small>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>
            
            <div class="officer-selector">
                <label for="venn-officer-select">Select Officer (Admin View):</label>
                <select id="venn-officer-select">
                    <option value="">-- Select Officer --</option>
                </select>
            </div>

            <div class="main-grid">
                <div class="card" id="request-card" style="margin-bottom: 0;">
                    <div class="card-body">
                        <h3>Request New Items</h3>
                        <p style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 1rem;">Request items in bulk from the administrator.</p>
                        <form id="request-form">
                            <div class="form-group">
                                <label for="request-type" style="font-size: 0.9rem;">Item Type</label>
                                <select id="request-type" class="form-control" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="tablet">Tablet</option>
                                    <option value="phone">Phone</option>
                                    <option value="charger">Charger</option>
                                    <option value="bag">Bag</option>
                                    <option value="power-bank">Power Bank</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="request-quantity" style="font-size: 0.9rem;">Quantity</label>
                                <input type="number" id="request-quantity" class="form-control" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="request-reason" style="font-size: 0.9rem;">Reason / Activity</label>
                                <textarea id="request-reason" class="form-control" rows="2" placeholder="e.g., For BHS Survey..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Request</button>
                        </form>
                    </div>
                </div>

                <div class="dashboard-stats-container">
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-value" id="total-district-items">0</div>
                                <div class="stat-label">Total Items</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-value" id="available-district-items">0</div>
                                <div class="stat-label">Items Available to Use</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-value" id="in-use-district-items">0</div>
                                <div class="stat-label">Items Currently in Use</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-value" id="pending-items">0</div>
                                <div class="stat-label">Items Pending Acknowledgement</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Last Update</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body">
                    </tbody>
                </table>
            </div>
            
        </main>
    </div>

    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>Transfer to Supervisor</h3>
            <p>Transfer <strong id="transfer-item-name"></strong> to a Supervisor.</p>
            <form id="transfer-form">
                <input type="hidden" id="transfer-item-id">
                <div class="form-group">
                    <label for="supervisor-select-modal">Supervisor</LabeL>
                    <select class="form-control" id="supervisor-select-modal" required>
                        <option value="">-- Select a Supervisor --</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Transfer</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="incident-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>Report an Incident</h3>
            <form id="incident-form">
                <div class="form-group">
                    <label for="incident-item-select">Select Item *</label>
                    <select id="incident-item-select" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="incident-type">Incident Type *</label>
                    <select id="incident-type" class="form-control" required>
                        <option value="">-- Select Type --</option>
                        <option value="Lost">Lost</option>
                        <option value="Stolen">Stolen</option>
                        <option value="Damaged Beyond Repair">Damaged Beyond Repair</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="incident-details">Incident Details *</label>
                    <textarea id="incident-details" class="form-control" rows="4" required placeholder="Provide a detailed description of what happened..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline modal-close">Cancel</button>
                    <button type="submit" class="btn btn-danger">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="notification-toast" class="notification"></div>

    <script>
        // Global variable to hold the data of the officer currently being viewed.
        let currentVennOfficer = null;
        
        // --- UPDATED KEYS ---
        const VENN_OFFICERS_KEY = 'vennOfficers'; // Correct key
        const SUPERVISORS_KEY = 'supervisors';
        const INVENTORY_KEY = 'inventoryData';
        const MOVEMENT_LOGS_KEY = 'movementLogs';
        const ADMIN_NOTIFICATIONS_KEY = 'adminNotifications';

        document.addEventListener('DOMContentLoaded', () => {
            initializeVennOfficerDashboard();
        });
        
        window.addEventListener('storage', (e) => {
            if ([INVENTORY_KEY, VENN_OFFICERS_KEY, MOVEMENT_LOGS_KEY].includes(e.key) && currentVennOfficer) {
                loadVennOfficerData();
            }
        });

        function initializeVennOfficerDashboard() {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const officerSelectorDiv = document.querySelector('.officer-selector');
            
            setupEventListeners();
            
            if (user.role === 'admin') {
                // ADMIN VIEW
                officerSelectorDiv.style.display = 'flex';
                document.getElementById('user-name').textContent = 'Admin';
                document.getElementById('user-avatar').textContent = 'A';
                document.getElementById('user-role').textContent = 'Administrator';
                loadVennOfficersDropdown();
            } else if (user.role === 'venn_officer') { // <-- CORRECTED ROLE CHECK
                // VENN OFFICER VIEW
                officerSelectorDiv.style.display = 'none';
                const officers = getVennOfficers(); // <-- CORRECTED FUNCTION
                // Find officer by their unique username
                const officerDetails = officers.find(o => o.name === user.username && o.district === user.district);
                
                if (officerDetails) {
                    setCurrentVennOfficer(officerDetails);
                } else {
                    console.error("Security Alert: Logged-in Venn Officer could not be found in the database.");
                    document.getElementById('district-name').textContent = 'Error';
                    document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--danger);">Could not load your data. Please contact an administrator.</td></tr>';
                }
            }
        }
        
        // --- Data Access Functions ---
        const getVennOfficers = () => JSON.parse(localStorage.getItem(VENN_OFFICERS_KEY)) || []; // <-- CORRECTED
        const getSupervisors = () => JSON.parse(localStorage.getItem(SUPERVISORS_KEY)) || [];
        const getInventoryData = () => JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];
        const saveInventoryData = (inventory) => {
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            window.dispatchEvent(new Event('storage'));
        };
        
        function logMovement(itemId, action, details) {
            let movementLogs = JSON.parse(localStorage.getItem(MOVEMENT_LOGS_KEY)) || [];
            const actor = JSON.parse(sessionStorage.getItem('loggedInUser')).username;
            movementLogs.unshift({
                itemId,
                action,
                details: `${details} (Action by: ${actor} in ${currentVennOfficer.district})`,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(MOVEMENT_LOGS_KEY, JSON.stringify(movementLogs));
        }

        function loadVennOfficersDropdown() {
            const officers = getVennOfficers(); // <-- CORRECTED
            const dropdown = document.getElementById('venn-officer-select');
            dropdown.innerHTML = '<option value="">-- Select Officer to View --</option>';
            officers.forEach(officer => {
                if (officer.status === 'active') {
                    const option = new Option(`${officer.name} (${officer.district})`, officer.id);
                    dropdown.appendChild(option);
                }
            });
        }
        
        function setCurrentVennOfficer(officer) {
            currentVennOfficer = officer;

            if (currentVennOfficer) {
                // Update header with the currently viewed officer's info
                document.getElementById('user-name').textContent = currentVennOfficer.name;
                document.getElementById('user-avatar').textContent = currentVennOfficer.name.charAt(0).toUpperCase();
                document.getElementById('user-role').textContent = 'Venn Officer';
                document.getElementById('district-name').textContent = currentVennOfficer.district;
                
                // Load data specific to this officer's district
                loadVennOfficerData();
            } else {
                // Clear the dashboard if no officer is selected (for admin view)
                document.getElementById('district-name').textContent = 'District';
                document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:1.5rem;">Select an officer to view their inventory.</td></tr>';
                updateStats([]);
            }
        }
        
        function loadVennOfficerData() {
            if (!currentVennOfficer) return;
            
            const allInventory = getInventoryData();
            // SECURITY: Filter all inventory to ONLY items in the current officer's district.
            const districtInventory = allInventory.filter(item => 
                item.district && item.district.toLowerCase() === currentVennOfficer.district.toLowerCase()
            );
            
            updateStats(districtInventory);
            renderTable(districtInventory);
        }

        function updateStats(districtInventory) {
            document.getElementById('total-district-items').textContent = districtInventory.length;
            document.getElementById('available-district-items').textContent = districtInventory.filter(item => item.status === 'available').length;
            document.getElementById('in-use-district-items').textContent = districtInventory.filter(item => item.status === 'in-use').length;
            document.getElementById('pending-items').textContent = districtInventory.filter(item => item.status === 'pending-transfer').length;
        }

        function renderTable(items) {
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = '';

            if (items.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No items found in this district.</td></tr>';
                return;
            }
            // Sort to show items needing action first
            items.sort((a, b) => {
                const statusOrder = { 'pending-transfer': 1, 'in-use': 2, 'available': 3 };
                return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99) || a.id.localeCompare(b.id);
            });
            
            items.forEach(item => {
                const row = document.createElement('tr');
                let statusClass = `status-${item.status.replace(/_/g, '-')}`;
                // Custom logic for display
                let assignedTo = item.assigned || 'N/A';
                if (item.status === 'in-use' && item.assigned === currentVennOfficer.name) {
                    assignedTo = 'In Use (Self)';
                }

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td><span class="status-badge ${statusClass}">${item.status.replace(/-/g, ' ').toUpperCase()}</span></td>
                    <td>${assignedTo}</td>
                    <td>${item.lastUpdate}</td>
                    <td class="action-buttons">${generateActionButtons(item)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function generateActionButtons(item) {
            let buttons = '';
            switch(item.status) {
                case 'pending-transfer':
                    buttons = `<button class="btn btn-success btn-sm acknowledge-btn" data-item-id="${item.id}"><i class="fas fa-check-circle"></i> Acknowledge</button>`;
                    break;
                case 'available':
                    buttons = `<button class="btn btn-primary btn-sm assign-self-btn" data-item-id="${item.id}"><i class="fas fa-user"></i> Use Item</button>
                            <button class="btn btn-outline btn-sm transfer-supervisor-btn" data-item-id="${item.id}"><i class="fas fa-exchange-alt"></i> Transfer to Supervisor</button>`;
                    break;
                case 'in-use':
                    buttons = `<button class="btn btn-success btn-sm mark-available-btn" data-item-id="${item.id}"><i class="fas fa-undo"></i> Stop Using</button>`;
                    break;
                case 'maintenance':
                     buttons = `<button class="btn btn-success btn-sm activate-btn" data-item-id="${item.id}"><i class="fas fa-check"></i> Mark as Available</button>`;
                     break;
                case 'reported-missing':
                    buttons = 'Awaiting Admin Review';
                    break;
                default:
                    buttons = 'No actions available';
            }
            // Add incident report button for items in use or available
            if (['available', 'in-use', 'maintenance'].includes(item.status)) {
                 buttons += ` <button class="btn btn-danger btn-sm incident-btn" data-item-id="${item.id}"><i class="fas fa-exclamation-triangle"></i> Report</button>`;
            }
            return buttons;
        }

        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            });
            
            document.getElementById('venn-officer-select').addEventListener('change', (e) => {
                const selectedId = e.target.value;
                const selectedOfficer = selectedId ? getVennOfficers().find(o => o.id == selectedId) : null; // <-- CORRECTED
                setCurrentVennOfficer(selectedOfficer);
            });
            
            document.getElementById('inventory-table-body').addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                const itemId = button.dataset.itemId;
                if (button.classList.contains('acknowledge-btn')) handleAcknowledge(itemId);
                if (button.classList.contains('assign-self-btn')) handleAssignSelf(itemId);
                if (button.classList.contains('transfer-supervisor-btn')) openTransferModal(itemId);
                if (button.classList.contains('mark-available-btn')) handleReceiveFromSelf(itemId);
                if (button.classList.contains('activate-btn')) handleStatusChange(itemId, 'available', 'Item marked as available from maintenance.');
                if (button.classList.contains('incident-btn')) openIncidentModal(itemId);
            });

            // Modals
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal').style.display = 'none');
            });
            window.addEventListener('click', e => {
                if(e.target.classList.contains('modal')) e.target.style.display = 'none';
            });
            
            // Forms
            document.getElementById('request-form').addEventListener('submit', handleItemRequest);
            document.getElementById('transfer-form').addEventListener('submit', handleTransferSubmit);
            document.getElementById('incident-form').addEventListener('submit', handleIncidentReport);
        }
        
        // --- ACTION HANDLERS ---
        
        function handleAcknowledge(itemId) {
            if (confirm('Acknowledge receipt of this item? It will become available.')) {
                handleStatusChange(itemId, 'available', 'Item acknowledged and made available.');
            }
        }
        
        function handleAssignSelf(itemId) {
            if (confirm('Assign this item to yourself?')) {
                let inventory = getInventoryData();
                const itemIndex = inventory.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    inventory[itemIndex].status = 'in-use';
                    inventory[itemIndex].assigned = currentVennOfficer.name; // Assign to self
                    inventory[itemIndex].lastUpdate = new Date().toLocaleDateString();
                    saveInventoryData(inventory);
                    logMovement(itemId, 'assignment', `Item assigned to self (${currentVennOfficer.name}).`);
                    showNotification(`Item assigned to self.`);
                    loadVennOfficerData();
                }
            }
        }

        function handleReceiveFromSelf(itemId) {
            const item = getInventoryData().find(i => i.id === itemId);
            if (confirm(`Stop using "${item.name}"? The item will become available.`)) {
                handleStatusChange(itemId, 'available', `Item marked as available (stopped using).`);
            }
        }

        function handleStatusChange(itemId, newStatus, logMessage = null) {
            let inventory = getInventoryData();
            const itemIndex = inventory.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const oldStatus = inventory[itemIndex].status;
                inventory[itemIndex].status = newStatus;
                inventory[itemIndex].lastUpdate = new Date().toLocaleDateString();
                
                if (['available', 'in-storage-field', 'maintenance'].includes(newStatus)) {
                    inventory[itemIndex].assigned = ''; // Clear assignment
                }
                
                saveInventoryData(inventory);
                logMovement(itemId, 'status_change', logMessage || `Status changed from ${oldStatus} to ${newStatus}.`);
                showNotification(`Item status updated to ${newStatus}.`);
                loadVennOfficerData();
            }
        }

        function openTransferModal(itemId) {
            const item = getInventoryData().find(i => i.id === itemId);
            const modal = document.getElementById('transfer-modal');
            if (item) {
                document.getElementById('transfer-item-name').textContent = `${item.name} (${item.id})`;
                document.getElementById('transfer-item-id').value = item.id;
                
                // Populate supervisor dropdown
                const supervisorDropdown = document.getElementById('supervisor-select-modal');
                const supervisors = getSupervisors().filter(s => s.status === 'active');
                supervisorDropdown.innerHTML = '<option value="">-- Select a Supervisor --</option>';
                supervisors.forEach(s => {
                    const option = new Option(`${s.name} (${s.district})`, s.id);
                    supervisorDropdown.appendChild(option);
                });
                
                modal.style.display = 'flex';
            }
        }
        
        function handleTransferSubmit(e) {
            e.preventDefault();
            const itemId = document.getElementById('transfer-item-id').value;
            const supervisorId = document.getElementById('supervisor-select-modal').value;
            
            if (!supervisorId) {
                showNotification("Please select a supervisor.");
                return;
            }
            
            const supervisor = getSupervisors().find(s => s.id == supervisorId);
            if (!supervisor) {
                showNotification("Error: Selected supervisor not found.");
                return;
            }

            let inventory = getInventoryData();
            const itemIndex = inventory.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                // Change item status and district
                inventory[itemIndex].status = 'pending-transfer';
                inventory[itemIndex].district = supervisor.district; // Move to supervisor's district
                inventory[itemIndex].assigned = ''; // Clear local assignment
                inventory[itemIndex].lastUpdate = new Date().toLocaleDateString();
                
                saveInventoryData(inventory);
                
                const logDetail = `Transferred from Venn Officer ${currentVennOfficer.name} to Supervisor ${supervisor.name} (${supervisor.district}). Awaiting acknowledgement.`;
                logMovement(itemId, 'transfer_initiated', logDetail);
                showNotification(`Item successfully sent to ${supervisor.name}.`);

                document.getElementById('transfer-modal').style.display = 'none';
                loadVennOfficerData(); // Refresh current officer's view (item will disappear)
            }
        }
        
        function handleItemRequest(e) {
            e.preventDefault();
            if (!currentVennOfficer) {
                showNotification("Cannot submit request. User data not loaded.", "error");
                return;
            }
            
            const type = document.getElementById('request-type').value;
            const quantity = document.getElementById('request-quantity').value;
            const reason = document.getElementById('request-reason').value.trim() || 'N/A';
            
            if (!type || !quantity || quantity < 1) {
                showNotification("Please select a type and a valid quantity.", "error");
                return;
            }
            
            let notifications = JSON.parse(localStorage.getItem(ADMIN_NOTIFICATIONS_KEY)) || [];
            
            const newNotification = {
                id: `notif-req-${Date.now()}`,
                message: `<strong>Item Request:</strong> ${quantity} x ${type}(s) requested by ${currentVennOfficer.name} (${currentVennOfficer.district}).<br><strong>Reason:</strong> ${reason}`,
                timestamp: new Date().toISOString(),
                read: false,
                type: 'item_request',
                itemId: null // Not tied to a specific item
            };

            notifications.unshift(newNotification);
            localStorage.setItem(ADMIN_NOTIFICATIONS_KEY, JSON.stringify(notifications));

            showNotification('Request submitted to administrator.');
            e.target.reset();
        }

        function openIncidentModal(itemId) {
            if (!currentVennOfficer) { showNotification('Please select an officer first.'); return; }
            const modal = document.getElementById('incident-modal');
            const itemSelect = document.getElementById('incident-item-select');
            
            // Populate with all items from this officer's district that *could* have an incident
            const reportableItems = getInventoryData().filter(item => 
                item.district && item.district.toLowerCase() === currentVennOfficer.district.toLowerCase() &&
                ['in-use', 'available', 'maintenance'].includes(item.status)
            );
            
            itemSelect.innerHTML = '<option value="">-- Select an Item --</option>';
            if (reportableItems.length === 0) { 
                showNotification('No reportable items found in your inventory.'); 
                return; 
            }
            
            reportableItems.forEach(item => {
                let displayText = `${item.name} (${item.id}) - Status: ${item.status}`;
                if(item.assigned) displayText += ` (Assigned: ${item.assigned})`;
                const option = new Option(displayText, item.id);
                itemSelect.add(option);
            });
            
            // If the button click passed an ID, pre-select it
            if(itemId) {
                itemSelect.value = itemId;
            }
            
            document.getElementById('incident-form').reset();
            if(itemId) itemSelect.value = itemId; // Re-set after reset
            
            modal.style.display = 'flex';
        }

        function handleIncidentReport(e) {
            e.preventDefault();
            const itemId = document.getElementById('incident-item-select').value;
            const incidentType = document.getElementById('incident-type').value;
            const incidentDetails = document.getElementById('incident-details').value.trim();

            if (!itemId || !incidentType || !incidentDetails) { showNotification('Please fill all required fields.', 'error'); return; }

            let inventory = getInventoryData();
            const itemIndex = inventory.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const originalAssignee = inventory[itemIndex].assigned;
                inventory[itemIndex].status = 'reported-missing';
                inventory[itemIndex].assigned = ''; 
                inventory[itemIndex].lastUpdate = new Date().toLocaleDateString();
                saveInventoryData(inventory);
                
                let logDetail = `Incident Reported: ${incidentType}.`;
                if (originalAssignee) logDetail += ` Previously assigned to: ${originalAssignee}.`;
                logDetail += ` Details: ${incidentDetails}.`;

                logMovement(itemId, 'incident_report', logDetail);
                showNotification('Incident report submitted successfully for admin review.');
                document.getElementById('incident-modal').style.display = 'none';
                loadVennOfficerData();
            }
        }

        // --- UTILITY ---
        function showNotification(message) {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
