<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV Inventory Hub | Field Office</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-title p {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
         .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--secondary);
            font-weight: 500;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .inventory-table thead th {
            text-align: left;
            padding: 1.25rem;
            background: var(--light);
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--border);
        }
        
        .inventory-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
        }

        .inventory-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .inventory-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .inventory-table td {
            padding: 1rem 1.25rem;
            vertical-align: middle;
            font-size: 0.9rem;
            color: #475569;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        
        .status-available { color: #065f46; background-color: #d1fae5; }
        .status-in-use { color: #1e40af; background-color: #dbeafe; }
        .status-maintenance { color: #92400e; background-color: #fef3c7; }
        .status-retired { color: #991b1b; background-color: #fee2e2; }
        .status-pending-approval { color: #9a3412; background-color: #ffedd5; }
        .status-in-storage-field { color: #5b21b6; background-color: #ede9fe; }
        .status-reported-missing { color: #b91c1c; background-color: #fee2e2; }


        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0da271; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--secondary); }
        .btn-outline:hover { background: var(--light); }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 700px;
            position: relative;
        }
        
        .modal-content h3 { margin-bottom: 1.5rem; color: var(--dark); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 1rem; right: 1.5rem; }
        .modal-close:hover, .modal-close:focus { color: #000; text-decoration: none; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        .modal-footer { margin-top: 1.5rem; text-align: right; }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            font-size: 0.9rem;
        }
        
        .notification.show { opacity: 1; visibility: visible; }
        
        .selector-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .selector-container label {
            font-weight: 500;
            color: var(--dark);
        }
        
        .selector-container select {
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: white;
        }
        
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 150px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .quick-action-btn i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .quick-action-btn span {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <script>
        // --- SECURITY CHECK ---
        // This script runs first to protect the page before anything is rendered.
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            // If no user is logged in, redirect to the login page immediately.
            window.location.href = 'login.html';
        } else if (loggedInUser.role !== 'admin' && loggedInUser.role !== 'field_officer') {
            // If the user is logged in but is neither an admin nor a field officer,
            // redirect them away. A supervisor, for example, should go to their own page.
            window.location.href = 'supervisor.html';
        }
    </script>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="RTV Inventory Hub Logo" class="sidebar-logo">
                <h2>RTV Inventory Hub</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
                <a href="Inventory.html" class="menu-item">
                    <i class="fas fa-list"></i>
                    <span class="menu-text">Inventory</span>
                </a>
                <a href="supervisor.html" class="menu-item">
                    <i class="fas fa-user-shield"></i>
                    <span class="menu-text">Supervisor</span>
                </a>
                <a href="field_office.html" class="menu-item active">
                    <i class="fas fa-warehouse"></i>
                    <span class="menu-text">Field Office</span>
                </a>
                <a href="venn_officer.html" class="menu-item"><i class="fas fa-user-tie"></i><span>Venn Officer</span></a>
                <a href="transfers.html" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="menu-text">Transfers</span>
                </a>
                <a href="reports.html" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Reports</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1>Field Office Dashboard (<span id="district-name"></span>)</h1>
                    <p>Manage items in storage and prepare them for return to the central store.</p>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <div class="avatar" id="manager-avatar">F</div>
                        <div>
                            <div id="manager-name">Field Manager</div>
                            <small id="manager-role">District Officer</small>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>
            
            <div class="selector-container">
                <label for="district-select">Select Field Office (District):</label>
                <select id="district-select">
                    <option value="">-- Select District --</option>
                </select>
            </div>
            
            <div class="quick-actions">
                <div class="quick-action-btn" id="return-to-admin-btn">
                    <i class="fas fa-upload"></i>
                    <span>Bulk Return to Admin</span>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-body">
                        <div class="stat-value" id="total-district-items">0</div>
                        <div class="stat-label">Total Items in District</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-body">
                        <div class="stat-value" id="items-with-supervisors">0</div>
                        <div class="stat-label">Items with Supervisors</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-body">
                        <div class="stat-value" id="items-in-storage">0</div>
                        <div class="stat-label">Items in Field Storage</div>
                    </div>
                </div>
                 <div class="card" style="margin-bottom: 0;">
                    <div class="card-body">
                        <div class="stat-value" id="items-in-maintenance">0</div>
                        <div class="stat-label">Items Needing Maintenance</div>
                    </div>
                </div>
            </div>

            <div class="card" id="acknowledgement-card">
                <div class="card-header">
                    <h2>Acknowledge Supervisor Returns</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Returned From</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="acknowledgement-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                 <div class="card-header">
                    <h2>Full District Inventory</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </main>
    </div>
    
    <div id="bulk-action-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 id="bulk-modal-title">Bulk Action</h3>
            <div id="bulk-modal-content"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline modal-close">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-bulk-action">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="notification-toast" class="notification"></div>

    <script>
        let currentDistrict = null;
        
        const INVENTORY_KEY = 'inventoryData';
        const DISTRICTS_KEY = 'districts';
        const MOVEMENT_LOGS_KEY = 'movementLogs';
        const SUPERVISORS_KEY = 'supervisors'; // Added to find supervisor name

        document.addEventListener('DOMContentLoaded', () => {
            initializeFieldOfficeDashboard();
        });
        
        window.addEventListener('storage', (e) => {
            if ([INVENTORY_KEY, DISTRICTS_KEY, MOVEMENT_LOGS_KEY, SUPERVISORS_KEY].includes(e.key)) {
                loadFieldOfficeData();
            }
        });

        function initializeFieldOfficeDashboard() {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const selectorContainer = document.querySelector('.selector-container');
            const userProfileName = document.getElementById('manager-name');
            const userProfileAvatar = document.getElementById('manager-avatar');
            const userProfileRole = document.getElementById('manager-role');

            setupEventListeners(); // Setup listeners for everyone

            if (user.role === 'admin') {
                // Admin setup
                selectorContainer.style.display = 'flex';
                userProfileName.textContent = user.username;
                userProfileAvatar.textContent = user.username.charAt(0).toUpperCase();
                userProfileRole.textContent = 'Administrator (Viewing)';

                loadDistrictDropdown(); // Load all districts for admin
                
                // Restore last selected district for convenience
                const lastDistrict = localStorage.getItem('lastSelectedFieldOffice');
                if (lastDistrict) {
                    document.getElementById('district-select').value = lastDistrict;
                    setCurrentDistrict(lastDistrict);
                } else {
                    // If no district was previously selected, clear the view
                    updateStats([]);
                    renderTable([]);
                    renderAcknowledgementTable([]);
                    document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Please select a field office.</td></tr>';
                }
            } else if (user.role === 'field_officer') {
                // Field Officer setup
                selectorContainer.style.display = 'none'; // Hide dropdown
                userProfileName.textContent = user.username;
                userProfileAvatar.textContent = user.username.charAt(0).toUpperCase();
                userProfileRole.textContent = 'District Officer';

                if (user.district) {
                    // Force view to their assigned district
                    setCurrentDistrict(user.district.toLowerCase());
                } else {
                    console.error("Field officer is not assigned to a district.");
                    document.getElementById('district-name').textContent = 'Error';
                    document.getElementById('inventory-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger);">You are not assigned to a district. Please contact an administrator.</td></tr>';
                }
            }
        }
        
        // --- Data Access Functions ---
        const getInventoryData = () => JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];
        const getDistricts = () => JSON.parse(localStorage.getItem(DISTRICTS_KEY)) || [];
        const getSupervisors = () => JSON.parse(localStorage.getItem(SUPERVISORS_KEY)) || [];
        const getMovementLogs = () => JSON.parse(localStorage.getItem(MOVEMENT_LOGS_KEY)) || [];
        const saveInventoryData = (inventory) => {
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            window.dispatchEvent(new Event('storage'));
        };
        
        function logMovement(itemId, action, details) {
            let movementLogs = JSON.parse(localStorage.getItem(MOVEMENT_LOGS_KEY)) || [];
            const actor = JSON.parse(sessionStorage.getItem('loggedInUser')).username;
            movementLogs.unshift({
                itemId,
                action,
                details: `${details} (Action by ${actor} at Field Office: ${currentDistrict})`,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(MOVEMENT_LOGS_KEY, JSON.stringify(movementLogs));
        }

        // ---
        // --- ðŸš¨ BUG FIX ðŸš¨
        // --- The original function would crash if settings.html was visited,
        // --- as 'districts' would become an object array, and d.trim() would fail.
        // --- This new function correctly handles both string[] and object[] data.
        // ---
        function loadDistrictDropdown() {
            const districtsData = getDistricts();
            const dropdown = document.getElementById('district-select');
            
            dropdown.innerHTML = '<option value="">-- Select District --</option>';
            
            let districtNames = [];
            if (districtsData.length > 0) {
                 if (typeof districtsData[0] === 'string') {
                    // Handles data from login.html seeder (e.g., ["Kampala", "Gulu"])
                    districtNames = districtsData.sort();
                } else if (typeof districtsData[0] === 'object' && districtsData[0].name) {
                    // Handles data from settings.html (e.g., [{name: "Kampala", ...}])
                    districtNames = districtsData.map(d => d.name).sort();
                }
            }
           
            districtNames.forEach(districtName => {
                // Field offices are any district that is not the central store (Mbarara)
                if (districtName.toLowerCase() !== 'mbarara') { 
                    const option = document.createElement('option');
                    option.value = districtName.toLowerCase();
                    option.textContent = districtName; // Use the original cased name for display
                    dropdown.appendChild(option);
                }
            });
        }
        
        function setCurrentDistrict(district) {
            if (!district) {
                currentDistrict = null;
                document.getElementById('district-name').textContent = 'N/A';
                loadFieldOfficeData(); 
                return;
            }
            currentDistrict = district;
            
            localStorage.setItem('lastSelectedFieldOffice', district);
            
            // --- FIX ---
            // Find the proper display name from the (potentially mixed-type) districts data
            const districtsData = getDistricts();
            let formattedName = district; // Default
            if (districtsData.length > 0) {
                 if (typeof districtsData[0] === 'string') {
                    formattedName = districtsData.find(d => d.toLowerCase() === district) || district;
                 } else if (typeof districtsData[0] === 'object' && districtsData[0].name) {
                    const districtObj = districtsData.find(d => d.name.toLowerCase() === district);
                    if (districtObj) formattedName = districtObj.name;
                 }
            }
            // --- END FIX ---
            
            document.getElementById('district-name').textContent = formattedName;
            
            loadFieldOfficeData();
        }
        
        function loadFieldOfficeData() {
            if (!currentDistrict) {
                updateStats([]);
                renderTable([]);
                renderAcknowledgementTable([]);
                return;
            };
            
            const allInventory = getInventoryData();
            // Security: Filter all data to only items within the currently selected district.
            const districtInventory = allInventory.filter(item => item.district && item.district.toLowerCase() === currentDistrict);
            
            updateStats(districtInventory);
            renderTable(districtInventory);
            
            const returnedItems = districtInventory.filter(item => item.status === 'in-storage-field');
            renderAcknowledgementTable(returnedItems);
        }

        function updateStats(districtInventory) {
            document.getElementById('total-district-items').textContent = districtInventory.length;
            // Items with supervisors are those "in-use" by data collectors or "available" in the supervisor's local stock.
            document.getElementById('items-with-supervisors').textContent = districtInventory.filter(item => ['in-use', 'available', 'maintenance', 'reported-missing'].includes(item.status)).length;
            document.getElementById('items-in-storage').textContent = districtInventory.filter(item => item.status === 'in-storage-field').length;
            document.getElementById('items-in-maintenance').textContent = districtInventory.filter(item => item.status === 'maintenance').length;
        }

        function renderTable(items) {
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = '';

            if (items.length === 0) {
                const message = currentDistrict ? 'No items found in this field office.' : 'Please select a field office to view its inventory.';
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">${message}</td></tr>`;
                return;
            }
            
            // Sort items to bring actionable items (e.g., in storage) to the top.
            items.sort((a, b) => {
                const statusOrder = { 'in-storage-field': 1, 'in-use': 2, 'available': 3, 'maintenance': 4, 'reported-missing': 5 };
                return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99) || a.id.localeCompare(b.id);
            });
            
            items.forEach(item => {
                const row = document.createElement('tr');
                let statusClass = `status-${item.status.replace(/_/g, '-')}`;

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td><span class="status-badge ${statusClass}">${item.status.replace(/-/g, ' ').toUpperCase()}</span></td>
                    <td>${item.assigned || 'N/A'}</td>
                    <td>${item.lastUpdate}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function renderAcknowledgementTable(returnedItems) {
            const tableBody = document.getElementById('acknowledgement-table-body');
            const logs = getMovementLogs();
            tableBody.innerHTML = '';
            
            if (!currentDistrict) {
                 tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 1.5rem;">Select a district to see returns.</td></tr>';
                return;
            }
            if (returnedItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 1.5rem;">No items to acknowledge.</td></tr>';
                return;
            }
            
            // --- ðŸš¨ BUG FIX ---
            // Find the most recent "return to field office" log for each item to get the supervisor's name
            const returnLogMap = new Map();
            logs.forEach(log => {
                if (log.action === 'return' && !returnLogMap.has(log.itemId)) {
                    // Extract supervisor name from log details
                    const match = log.details.match(/from Supervisor (.*?)\./);
                    if (match) {
                        returnLogMap.set(log.itemId, match[1]);
                    }
                }
            });
            // --- END FIX ---

            returnedItems.forEach(item => {
                const supervisorName = returnLogMap.get(item.id) || 'Unknown Supervisor';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${supervisorName}</td>
                    <td>
                        <button class="btn btn-success" data-item-id="${item.id}" data-supervisor-name="${supervisorName}">
                            <i class="fas fa-check-circle"></i> Acknowledge
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function handleAcknowledgeReturn(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const itemId = button.dataset.itemId;
            const supervisorName = button.dataset.supervisorName;

            if (confirm(`Acknowledge receipt of item ${itemId} from ${supervisorName}? This will move it to the 'Return to Admin' queue.`)) {
                let inventory = getInventoryData();
                const itemIndex = inventory.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    inventory[itemIndex].status = 'pending-approval';
                    inventory[itemIndex].lastUpdate = new Date().toLocaleDateString();
                    saveInventoryData(inventory);
                    logMovement(itemId, 'acknowledge_return', `Item received from Supervisor ${supervisorName} at ${currentDistrict} field office.`);
                    showNotification(`Item ${itemId} acknowledged and is now pending return to admin.`);
                    loadFieldOfficeData();
                }
            }
        }
        
        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            });

            document.getElementById('district-select').addEventListener('change', (e) => {
                setCurrentDistrict(e.target.value);
            });
            
            // Listener for the acknowledgement table
            document.getElementById('acknowledgement-table-body').addEventListener('click', handleAcknowledgeReturn);
            
            // Connect the quick action button to the modal function
            document.getElementById('return-to-admin-btn').addEventListener('click', () => openBulkActionModal('return_to_admin'));

            // General modal close events
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal').style.display = 'none');
            });
            
            window.addEventListener('click', e => {
                if(e.target.classList.contains('modal')) e.target.style.display = 'none';
            });
            
            // Connect the modal's confirm button to its handler function
            document.getElementById('confirm-bulk-action').addEventListener('click', handleBulkActionConfirm);
        }
        
        function openBulkActionModal(actionType) {
            // --- FIX: Add guard clause ---
            if (!currentDistrict) {
                showNotification('Please select a field office first.');
                return;
            }
            // --- END FIX ---
            
            const modal = document.getElementById('bulk-action-modal');
            const modalTitle = document.getElementById('bulk-modal-title');
            const modalContent = document.getElementById('bulk-modal-content');
            
            const inventory = getInventoryData();
            let itemsForAction = [];
            let title = '';
            let contentHTML = '';
            
            if (actionType === 'return_to_admin') {
                title = 'Return Items to Admin (Mbarara Store)';
                // Add driver name input field
                contentHTML = `
                    <p>Select items to send back to the central store. This will put them in a "pending approval" state for the admin.</p>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="driver-name">Driver's Name *</label>
                        <input type="text" id="driver-name" class="form-control" required placeholder="Enter the full name of the driver">
                    </div>
                `;
                // MODIFIED: Can now only return items that have been acknowledged (pending-approval)
                itemsForAction = inventory.filter(item => 
                    item.district && item.district.toLowerCase() === currentDistrict && 
                    item.status === 'pending-approval'
                );
            }
            
            if (itemsForAction.length === 0) {
                showNotification(`No items have been acknowledged and are ready for return.`);
                return;
            }

            // Build the list of checkboxes for the modal
            contentHTML += `
                <div style="max-height: 300px; overflow-y: auto; margin-top: 1rem; border: 1px solid var(--border); padding: 0.5rem; border-radius: 8px;">
                    ${itemsForAction.map(item => `
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="bulk-item-${item.id}" value="${item.id}" style="margin-right: 0.5rem;">
                            <label for="bulk-item-${item.id}">${item.name} (${item.id}) - <i>Current Status: ${item.status.replace('-', ' ')}</i></label>
                        </div>
                    `).join('')}
                </div>`;
            
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            modal.dataset.actionType = actionType; // Store the action type for the confirm handler
            modal.style.display = 'flex';
        }
        
        function handleBulkActionConfirm() {
            const modal = document.getElementById('bulk-action-modal');
            const actionType = modal.dataset.actionType;
            const checkedItems = Array.from(modal.querySelectorAll('input[type="checkbox"]:checked'));
            
            if (checkedItems.length === 0) {
                showNotification('Please select at least one item.');
                return;
            }
            
            // Get and validate driver's name
            let driverName = '';
            if (actionType === 'return_to_admin') {
                const driverInput = document.getElementById('driver-name');
                driverName = driverInput.value.trim();
                if (!driverName) {
                    showNotification("Please enter the driver's name.");
                    driverInput.focus();
                    return;
                }
            }

            const itemIds = checkedItems.map(item => item.value);
            let inventory = getInventoryData();
            let successCount = 0;
            
            itemIds.forEach(itemId => {
                const itemIndex = inventory.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    const item = inventory[itemIndex];
                    if (actionType === 'return_to_admin') {
                        // The status is already pending-approval, so we just log the final step
                        item.lastUpdate = new Date().toLocaleDateString();
                        // Update log message with driver's name
                        logMovement(itemId, 'return_to_store', `Item physically sent from ${currentDistrict} via driver: ${driverName}. Awaiting admin receipt.`);
                    }
                    successCount++;
                }
            });
            
            saveInventoryData(inventory);
            showNotification(`Successfully processed ${successCount} item(s) for return.`);
            modal.style.display = 'none';
            loadFieldOfficeData(); // Refresh the dashboard view
        }

        function showNotification(message) {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
